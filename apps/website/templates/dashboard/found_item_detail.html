{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block page_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'assets/css/pages/found_item_detail.css' %}">
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<link rel="stylesheet" href="{% static 'notifications/css/notifications.css' %}">
{% endblock page_css %}

{% block content %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö —Ñ–æ—Ç–æ -->
<div id="modalGallery" class="modal-gallery">
    <span class="modal-close">&times;</span>
    <div class="modal-gallery-content">
        <button class="modern-nav-btn modal-prev"
        aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        <i class="ri-arrow-left-s-line"></i>
        </button>
        <button class="modern-nav-btn modal-next"
                aria-label="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
            <i class="ri-arrow-right-s-line"></i>
        </button>

        <div class="modal-gallery-slides">
            {% for image_url in image_urls %}
            <div class="modal-gallery-slide {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}">
                <img src="{{ image_url }}" class="modal-gallery-image" alt="{{ item.title }} - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ forloop.counter }}">
            </div>
            {% endfor %}
        </div>

        <div class="modal-indicators">
            <div class="modern-indicator-track">
                {% for image_url in image_urls %}
                <div class="modern-indicator {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é {{ forloop.counter }}"></div>
                {% endfor %}
            </div>
        </div>

        <div class="modal-gallery-thumbnails">
            {% for image_url in image_urls %}
            <div class="modal-gallery-thumbnail {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}">
                <img src="{{ image_url }}" alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ {{ forloop.counter }}">
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'website:found_items' %}">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</a></li>
        <li class="breadcrumb-item active">{{ item.title|truncatewords:5 }}</li>
    </ol>
</nav>

<div class="row">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-2">
                    <div>
                        <h4 class="card-title mb-0" style="font-size: 1.25rem;">{{ item.title }}</h4>
                        <!-- –î–∞—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
                        <div class="posted-info">
                            {% if item.posted_date and item.posted_date != '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' and item.posted_date != '–ù–µ —É–∫–∞–∑–∞–Ω–∞' %}
                            <div class="posted-date">
                                <i class="ri-calendar-event-line"></i>
                                <span>{{ item.posted_date }}</span>
                            </div>
                            {% endif %}

                            {% if item.product_id %}
                            <div class="product-id">
                                <i class="ri-hashtag"></i>
                                <span>{{ item.product_id }}</span>
                            </div>
                            {% endif %}

                            {% if item.views_count is not None %}
                            <div class="views-count">
                                <i class="ri-eye-line"></i>
                                <span>
                                    {{ item.views_count }}
                                    {% if item.views_today is not None %}(+{{ item.views_today }} —Å–µ–≥–æ–¥–Ω—è){% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="header-badges">
                        <!-- –ë–µ–π–¥–∂ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
                        {% if item.source == 'auto_ru' %}
                        <div class="source-badge source-auto-ru" title="Auto.ru">
                            <i class="ri-car-fill"></i>
                            <span>Auto.ru</span>
                        </div>
                        {% elif item.source == 'avito' %}
                        <div class="source-badge source-avito" title="–ê–≤–∏—Ç–æ">
                            <i class="ri-home-4-fill"></i>
                            <span>–ê–≤–∏—Ç–æ</span>
                        </div>
                        {% else %}
                        <div class="source-badge source-unknown" title="–î—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫">
                            <i class="ri-question-line"></i>
                            <span>{{ item.source|default:"–ò—Å—Ç–æ—á–Ω–∏–∫" }}</span>
                        </div>
                        {% endif %}

                        <!-- –†–µ–π—Ç–∏–Ω–≥ -->
                        {% if item.seller_rating %}
                        <div class="modern-rating">
                            <i class="ri-star-fill text-warning"></i>
                            <span class="fw-semibold">{{ item.seller_rating }}</span>
                        </div>
                        {% endif %}

                        <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
                        {% if item.views_count %}
                            {% if item.views_count < 20 %}
                            <div class="view-status-badge view-status-new" title="–ú–µ–Ω—å—à–µ 20 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤">
                                <i class="ri-fire-fill"></i>
                                <span>–ù–æ–≤–æ–µ</span>
                            </div>
                            {% elif item.views_count >= 21 and item.views_count <= 40 %}
                            <div class="view-status-badge view-status-fresh" title="21-40 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤">
                                <i class="ri-leaf-fill"></i>
                                <span>–°–≤–µ–∂–µ–µ</span>
                            </div>
                            {% elif item.views_count > 40 %}
                            <div class="view-status-badge view-status-old" title="–ë–æ–ª—å—à–µ 40 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤">
                                <i class="ri-time-line"></i>
                                <span>–°—Ç–∞—Ä–æ–µ</span>
                            </div>
                            {% endif %}
                        {% endif %}

                        <!-- –ë–ï–ô–î–ñ –°–ö–û–†–û–°–¢–ò (–ù–û–í–´–ô) - –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç—É—Ç -->
                        {% if item.time_status %}
                            {{ item.get_speed_badge }}
                        {% endif %}

                        <!-- –ü—Ä–æ–¥–∞–≤–µ—Ü -->
                        <div class="seller-badge-container">
                            {% if item.seller_type == '–ö–æ–º–ø–∞–Ω–∏—è' or item.seller_type == '–ú–∞–≥–∞–∑–∏–Ω' %}
                                <span class="seller-badge reseller">
                                    <i class="ri-store-2-line"></i>
                                    {{ item.seller_type }}
                                </span>
                            {% else %}
                                <span class="seller-badge private">
                                    <i class="ri-user-line"></i>
                                    {{ item.seller_type|default:"–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ" }}
                                </span>
                            {% endif %}

                            <!-- –°–µ—Ä–¥–µ—á–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ -->
                            <button class="header-favorite-btn {% if item.is_favorite %}active{% endif %}"
                                    data-item-id="{{ item.id }}"
                                    data-is-favorite="{{ item.is_favorite|yesno:'true,false' }}"
                                    title="{% if item.is_favorite %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}">
                                <i class="{% if item.is_favorite %}ri-heart-fill{% else %}ri-heart-line{% endif %}"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                {% if image_urls %}
                <div class="detail-gallery-container mb-3">
                    <div class="detail-gallery-track">
                        {% for image_url in image_urls %}
                        <div class="detail-gallery-slide">
                            <img src="{{ image_url }}"
                                 class="detail-gallery-image"
                                 alt="{{ item.title }} - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ forloop.counter }}"
                                 onerror="handleImageError(this)"
                                 loading="lazy"
                                 decoding="async"
                                 data-slide="{{ forloop.counter0 }}">
                        </div>
                        {% endfor %}
                    </div>

                    <div class="detail-gallery-overlay"></div>

                    {% if image_urls|length > 1 %}
                    <div class="detail-indicators">
                        <div class="detail-indicator-track">
                            {% for image_url in image_urls %}
                            <div class="detail-indicator {% if forloop.first %}active{% endif %}"
                                 data-slide="{{ forloop.counter0 }}"></div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="detail-photo-counter">
                        <i class="ri-camera-line me-1"></i>
                        <span>1/{{ image_urls|length }}</span>
                    </div>

                    <button class="modern-nav-btn modern-prev"
                            aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                        <i class="ri-arrow-left-s-line"></i>
                    </button>
                    <button class="modern-nav-btn modern-next"
                            aria-label="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                        <i class="ri-arrow-right-s-line"></i>
                    </button>
                    {% endif %}
                </div>

                <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –≥–∞–ª–µ—Ä–µ–∏ -->
                {% if image_urls|length > 1 %}
                <div class="gallery-thumbnails">
                    {% for image_url in image_urls %}
                    <div class="gallery-thumbnail {% if forloop.first %}active{% endif %}"
                         data-slide="{{ forloop.counter0 }}">
                        <img src="{{ image_url }}"
                             alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ {{ forloop.counter }}"
                             onerror="this.style.display='none'">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center rounded mb-4" style="height: 300px;">
                    <div class="text-center text-muted">
                        <i class="ri-image-line ri-3x mb-2 opacity-50"></i>
                        <p class="mb-0 opacity-75">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                    </div>
                </div>
                {% endif %}

                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ç—Ä–∏ —Å—Ç–æ–ª–±—Ü–∞ -->
                <div class="characteristics-section">
                    <h5 class="mb-3">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h5>
                    <div class="modern-details-grid three-columns-layout">
                        <div class="details-column">
                            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ -->
                            {% if item.condition %}
                            <div class="detail-item">
                                <i class="ri-checkbox-circle-line"></i>
                                <span class="detail-text">{{ item.condition }}</span>
                            </div>
                            {% endif %}

                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                            {% if item.category %}
                            <div class="detail-item">
                                <i class="ri-price-tag-3-line"></i>
                                <span class="detail-text">{{ item.category }}</span>
                            </div>
                            {% endif %}

                            <!-- –ì–æ–¥ -->
                            {% if item.year %}
                            <div class="detail-item">
                                <i class="ri-calendar-line"></i>
                                <span class="detail-text">{{ item.year }} –≥–æ–¥</span>
                            </div>
                            {% endif %}

                            <!-- –¶–≤–µ—Ç -->
                            {% if item.color %}
                            <div class="detail-item">
                                <i class="ri-palette-line"></i>
                                <span class="detail-text">{{ item.color }}</span>
                            </div>
                            {% endif %}

                            <!-- üî• –ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø - –ù–û–í–û–ï –ü–û–õ–ï -->
                            {% if item.package %}
                            <div class="detail-item">
                                <i class="ri-gift-line"></i>
                                <span class="detail-text">{{ item.package }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="details-column">
                            <!-- –ü—Ä–æ–±–µ–≥ -->
                            {% if item.mileage %}
                            <div class="detail-item">
                                <i class="ri-roadster-line"></i>
                                <span class="detail-text">{{ item.mileage }}</span>
                            </div>
                            {% endif %}

                            <!-- –î–≤–∏–≥–∞—Ç–µ–ª—å -->
                            {% if item.engine %}
                            <div class="detail-item">
                                <i class="ri-settings-5-line"></i>
                                <span class="detail-text">{{ item.engine }}</span>
                            </div>
                            {% endif %}

                            <!-- –ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á -->
                            {% if item.transmission %}
                            <div class="detail-item">
                                <i class="ri-settings-3-line"></i>
                                <span class="detail-text">{{ item.transmission }}</span>
                            </div>
                            {% endif %}

                            <!-- –ü—Ä–∏–≤–æ–¥ -->
                            {% if item.drive %}
                            <div class="detail-item">
                                <i class="ri-steering-2-line"></i>
                                <span class="detail-text">{{ item.drive }}</span>
                            </div>
                            {% endif %}

                            <!-- üî• –¢–ò–ü –ö–£–ó–û–í–ê - –ù–û–í–û–ï –ü–û–õ–ï -->
                            {% if item.body %}
                            <div class="detail-item">
                                <i class="ri-car-line"></i>
                                <span class="detail-text">{{ item.body }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="details-column">
                            <!-- –í–ª–∞–¥–µ–ª—å—Ü—ã -->
                            {% if item.owners %}
                            <div class="detail-item">
                                <i class="ri-user-shared-line"></i>
                                <span class="detail-text">{{ item.owners }}</span>
                            </div>
                            {% endif %}

                            <!-- –ü–¢–° -->
                            {% if item.pts %}
                            <div class="detail-item">
                                <i class="ri-file-text-line"></i>
                                <span class="detail-text">–ü–¢–°: {{ item.pts }}</span>
                            </div>
                            {% endif %}

                            <!-- –ù–∞–ª–æ–≥ -->
                            {% if item.tax %}
                            <div class="detail-item">
                                <i class="ri-money-dollar-circle-line"></i>
                                <span class="detail-text">–ù–∞–ª–æ–≥: {{ item.tax }}</span>
                            </div>
                            {% endif %}

                            <!-- –¢–∞–º–æ–∂–Ω—è -->
                            {% if item.customs %}
                            <div class="detail-item">
                                <i class="ri-passport-line"></i>
                                <span class="detail-text">–¢–∞–º–æ–∂–Ω—è: {{ item.customs }}</span>
                            </div>
                            {% endif %}

                            <!-- –†—É–ª—å -->
                            {% if item.steering %}
                            <div class="detail-item">
                                <i class="ri-steering-line"></i>
                                <span class="detail-text">–†—É–ª—å: {{ item.steering }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –∞–¥—Ä–µ—Å–∞ -->
                <div class="address-section">
                    <h5 class="mb-3">–ê–¥—Ä–µ—Å</h5>
                    <div class="address-column">
                        <!-- –ê–¥—Ä–µ—Å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º -->
                        {% if item.address %}
                        <div class="detail-item">
                            <i class="ri-map-pin-line"></i>
                            <span class="detail-text">{{ item.address }}</span>
                        </div>
                        {% endif %}

                        <!-- –ú–µ—Ç—Ä–æ -->
                        {% if metro_stations %}
                        <div class="detail-item">
                            <i class="ri-subway-line"></i>
                            <div class="metro-station-container">
                                <span class="detail-text">–ú–µ—Ç—Ä–æ:</span>
                                {% for station in metro_stations %}
                                {% if station.name %}
                                <div class="metro-badge metro-line-{{ station.line_number|default:'default' }}">
                                    <span class="metro-circle" style="background-color: {{ station.color|default:'#666' }};">
                                        {{ station.line_number|default:forloop.counter }}
                                    </span>
                                    {{ station.name }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                {% if item.description and item.description != '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' %}
                <div class="mt-4">
                    <h5 class="mb-3">–û–ø–∏—Å–∞–Ω–∏–µ</h5>
                    <div style="white-space: pre-line; line-height: 1.6; padding: 16px; background: #f8f9fa; border-radius: 8px; font-family: inherit; text-indent: 0; margin: 0;">
                        {{ item.description }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- –§—É—Ç–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div class="time-info">
        <small class="text-muted">–ù–∞–π–¥–µ–Ω–æ: {{ item.found_at|date:"d.m.Y H:i" }}</small>
    </div>
    <div class="action-buttons">
        <a href="{{ item.url }}" target="_blank" class="item-action-btn item-action-primary" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ {{ item.source|default:'—Å–∞–π—Ç–µ' }}">
            <i class="ri-external-link-line"></i>
            <span class="action-text">–ü–µ—Ä–µ–π—Ç–∏</span>
        </a>
        <button class="item-action-btn item-action-warning share-btn" data-item-id="{{ item.id }}" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
            <i class="ri-share-line"></i>
            <span class="action-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
        </button>
        <button class="item-action-btn item-action-danger favorite-btn {% if item.is_favorite %}active{% endif %}"
                data-item-id="{{ item.id }}"
                data-is-favorite="{{ item.is_favorite|yesno:'true,false' }}"
                title="{% if item.is_favorite %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}">
            <i class="{% if item.is_favorite %}ri-heart-fill{% else %}ri-heart-line{% endif %}"></i>
            <span class="action-text">{% if item.is_favorite %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º{% else %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}</span>
        </button>
    </div>
</div>
            </div>
        </div>
    </div>

<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
<div class="col-lg-4">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –¶–µ–Ω–∞ –∏ –ø—Ä–æ–¥–∞–≤–µ—Ü -->
    <div class="card card-seller featured mb-4">
        <div class="card-seller-body">
            <div class="sidebar-price-card">
                <div class="price-main">
                    {{ item.price|intcomma }} ‚ÇΩ
                </div>
                <div class="price-target">
                    —Ü–µ–ª—å {{ item.target_price|intcomma }} ‚ÇΩ
                    {% if item.price_status %}
                    <div class="price-status {% if '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è' in item.price_status %}price-fair{% elif '–í—ã—à–µ' in item.price_status %}price-high{% elif '–ù–∏–∂–µ' in item.price_status %}price-low{% endif %}">
                        {{ item.price_status }}
                    </div>
                    {% endif %}
                </div>

                {% load rating_filters %}
                <!-- –†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–∞ -->
                {% if item.seller_rating %}
                <div class="seller-rating-sidebar">
                    <div class="seller-avatar">
                        {% if item.seller_avatar %}
                            <img src="{{ item.seller_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä –ø—Ä–æ–¥–∞–≤—Ü–∞" onerror="this.src='/static/assets/img/avatars/1.png'">
                        {% else %}
                            <img src="/static/assets/img/avatars/1.png" alt="–ê–≤–∞—Ç–∞—Ä –ø—Ä–æ–¥–∞–≤—Ü–∞">
                        {% endif %}
                    </div>
                    <div class="seller-info-sidebar">
                        <div class="seller-rating">
                            <!-- –ó–í–ï–ó–î–´ –†–ï–ô–¢–ò–ù–ì–ê -->
                            <div class="seller-rating-stars">
                                {{ item.seller_rating|rating_stars|safe }}
                            </div>
                            <span class="fw-semibold">({{ item.seller_rating }})</span>
                        </div>
                        {% if item.seller_name %}
                            {% if item.seller_profile_url %}
                            <a href="{{ item.seller_profile_url }}" target="_blank" class="seller-name">
                                {{ item.seller_name }}
                            </a>
                            {% else %}
                            <div class="seller-name">{{ item.seller_name }}</div>
                            {% endif %}
                        {% endif %}
                        {% if item.reviews_count %}
                        <div class="seller-reviews">{{ item.reviews_count }} –æ—Ç–∑—ã–≤–æ–≤</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã -->
    {% if similar_items %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">–ü–æ—Ö–æ–∂–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h5>
        </div>
        <div class="card-body">
            <div class="similar-products-grid">
                {% for similar_item in similar_items %}
                <a href="{% url 'website:found_item_detail' similar_item.id %}" class="text-decoration-none">
                    <div class="similar-product-card">
                        <div class="similar-product-content">
                            {% with images=similar_item.get_images %}
                            <div class="similar-product-image">
                                {% if images %}
                                <img src="{{ images.0 }}"
                                     alt="{{ similar_item.title }}"
                                     onerror="this.style.display='none'">
                                {% else %}
                                <div class="image-placeholder h-100 d-flex align-items-center justify-content-center">
                                    <i class="ri-image-line opacity-50"></i>
                                </div>
                                {% endif %}
                            </div>
                            {% endwith %}

                            <div class="similar-product-info">
                                <h6 class="similar-product-title">{{ similar_item.title }}</h6>

                                <div class="similar-product-price">
                                    {{ similar_item.price|intcomma }} ‚ÇΩ
                                </div>

                                <div class="similar-product-details">
                                    {% if similar_item.city %}
                                    <div class="similar-product-detail">
                                        <i class="ri-map-pin-line"></i>
                                        <span>{{ similar_item.city }}</span>
                                    </div>
                                    {% endif %}

                                    {% if similar_item.posted_date %}
                                    <div class="similar-product-detail">
                                        <i class="ri-calendar-event-line"></i>
                                        <span>{{ similar_item.posted_date }}</span>
                                    </div>
                                    {% endif %}

                                    {% if similar_item.source %}
                                    <div class="similar-product-detail">
                                        <i class="ri-external-link-line"></i>
                                        <span>{{ similar_item.source }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function initDetailGallery() {
    const container = document.querySelector('.detail-gallery-container');
    if (!container) return;

    const track = container.querySelector('.detail-gallery-track');
    const slides = container.querySelectorAll('.detail-gallery-slide');
    const prevBtn = container.querySelector('.modern-prev');
    const nextBtn = container.querySelector('.modern-next');
    const indicators = container.querySelectorAll('.detail-indicator');
    const thumbnails = document.querySelectorAll('.gallery-thumbnail');
    const photoCounter = container.querySelector('.detail-photo-counter span');
    const totalSlides = slides.length;

    if (totalSlides <= 1) {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (indicators.length > 0) {
            container.querySelector('.detail-indicators').style.display = 'none';
        }
        if (thumbnails.length > 0) {
            document.querySelector('.gallery-thumbnails').style.display = 'none';
        }
        return;
    }

    let currentSlide = 0;

    function updateGallery() {
        if (track) {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentSlide);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.classList.toggle('active', index === currentSlide);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
        if (photoCounter) {
            photoCounter.textContent = `${currentSlide + 1}/${totalSlides}`;
        }
    }

    function goToSlide(slideIndex) {
        currentSlide = slideIndex;
        updateGallery();
    }

    function nextSlide() {
        currentSlide = (currentSlide + 1) % totalSlides;
        updateGallery();
    }

    function prevSlide() {
        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        updateGallery();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            prevSlide();
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            nextSlide();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', (e) => {
            e.stopPropagation();
            goToSlide(index);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            goToSlide(index);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–ª–∏–∫–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º (–æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞)
    slides.forEach((slide, index) => {
        const image = slide.querySelector('.detail-gallery-image');
        if (image) {
            image.addEventListener('click', (e) => {
                e.stopPropagation();
                openModalGallery(index);
            });
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateGallery();
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ–∏
function initModalGallery() {
    const modal = document.getElementById('modalGallery');
    const closeBtn = modal.querySelector('.modal-close');
    const prevBtn = modal.querySelector('.modal-prev');
    const nextBtn = modal.querySelector('.modal-next');
    const slides = modal.querySelectorAll('.modal-gallery-slide');
    const indicators = modal.querySelectorAll('.modern-indicator');
    const thumbnails = modal.querySelectorAll('.modal-gallery-thumbnail');
    const totalSlides = slides.length;

    let currentModalSlide = 0;

    function openModalGallery(startIndex = 0) {
        currentModalSlide = startIndex;
        updateModalGallery();
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeModalGallery() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function updateModalGallery() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥—ã
        slides.forEach((slide, index) => {
            slide.classList.toggle('active', index === currentModalSlide);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentModalSlide);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.classList.toggle('active', index === currentModalSlide);
        });
    }

    function nextModalSlide() {
        currentModalSlide = (currentModalSlide + 1) % totalSlides;
        updateModalGallery();
    }

    function prevModalSlide() {
        currentModalSlide = (currentModalSlide - 1 + totalSlides) % totalSlides;
        updateModalGallery();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    closeBtn.addEventListener('click', closeModalGallery);

    prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        prevModalSlide();
    });

    nextBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        nextModalSlide();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', (e) => {
            e.stopPropagation();
            currentModalSlide = index;
            updateModalGallery();
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            currentModalSlide = index;
            updateModalGallery();
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModalGallery();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            closeModalGallery();
        }
        if (e.key === 'ArrowLeft' && modal.style.display === 'block') {
            prevModalSlide();
        }
        if (e.key === 'ArrowRight' && modal.style.display === 'block') {
            nextModalSlide();
        }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è
    window.openModalGallery = openModalGallery;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function handleImageError(img) {
    img.style.display = 'none';
    const placeholder = img.closest('.detail-gallery-slide');
    if (placeholder) {
        placeholder.innerHTML = `
            <div class="image-placeholder h-100 d-flex align-items-center justify-content-center">
                <div class="text-center text-muted">
                    <i class="ri-image-line ri-2x mb-2 opacity-50"></i>
                    <p class="mb-0 small opacity-75">–ù–µ—Ç —Ñ–æ—Ç–æ</p>
                </div>
            </div>
        `;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function initFavoriteSystem() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–µ—Ä–¥–µ—á–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
    document.querySelectorAll('.header-favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const itemId = this.getAttribute('data-item-id');
            const isFavorite = this.getAttribute('data-is-favorite') === 'true';

            toggleFavorite(itemId, isFavorite, this, true);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ —Ñ—É—Ç–µ—Ä–µ
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const itemId = this.getAttribute('data-item-id');
            const isFavorite = this.getAttribute('data-is-favorite') === 'true';

            toggleFavorite(itemId, isFavorite, this, false);
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleFavorite(itemId, currentState, button, isHeaderButton) {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="ri-loader-4-line rotate"></i>';
    button.disabled = true;

    // –ï—Å–ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –∫–Ω–æ–ø–∫—É –≤ —Ñ—É—Ç–µ—Ä–µ –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
    const otherButton = isHeaderButton
        ? document.querySelector(`.favorite-btn[data-item-id="${itemId}"]`)
        : document.querySelector(`.header-favorite-btn[data-item-id="${itemId}"]`);

    if (otherButton) {
        otherButton.innerHTML = '<i class="ri-loader-4-line rotate"></i>';
        otherButton.disabled = true;
    }

    fetch(`/favorites/toggle/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'added' || data.status === 'removed') {
            updateFavoriteButton(button, data.status === 'added', isHeaderButton);
            if (otherButton) {
                updateFavoriteButton(otherButton, data.status === 'added', !isHeaderButton);
            }
            showFavoriteNotification(data.message, data.status);
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error toggling favorite:', error);
        showFavoriteNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
        button.innerHTML = originalHTML;
        button.disabled = false;
        if (otherButton) {
            otherButton.innerHTML = originalHTML;
            otherButton.disabled = false;
        }
    });
}

function updateFavoriteButton(button, isFavorite, isHeaderButton) {
    const icon = button.querySelector('i');

    if (isFavorite) {
        button.classList.add('active');
        button.setAttribute('data-is-favorite', 'true');
        button.setAttribute('title', '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        if (icon) {
            icon.className = isHeaderButton ? 'ri-heart-fill' : 'ri-heart-fill me-1';
        }
        if (!isHeaderButton) {
            const text = button.querySelector('.btn-text');
            if (text) {
                text.textContent = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º';
            }
        }
    } else {
        button.classList.remove('active');
        button.setAttribute('data-is-favorite', 'false');
        button.setAttribute('title', '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
        if (icon) {
            icon.className = isHeaderButton ? 'ri-heart-line' : 'ri-heart-line me-1';
        }
        if (!isHeaderButton) {
            const text = button.querySelector('.btn-text');
            if (text) {
                text.textContent = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            }
        }
    }

    button.disabled = false;
}

function showFavoriteNotification(message, type) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const titles = {
        'added': '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
        'removed': '–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ',
        'error': '–û—à–∏–±–∫–∞'
    };

    const icons = {
        'added': 'ri-heart-fill',
        'removed': 'ri-heart-line',
        'error': 'ri-error-warning-line'
    };

    switch(type) {
        case 'added':
            // –£—Å–ø–µ—Ö - –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            if (typeof notificationSuccess !== 'undefined') {
                notificationSuccess(message, titles[type]);
            } else {
                // Fallback –Ω–∞ toastr –µ—Å–ª–∏ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                toastr.success(message, titles[type]);
            }
            break;

        case 'removed':
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
            if (typeof notificationInfo !== 'undefined') {
                notificationInfo(message, titles[type]);
            } else {
                toastr.info(message, titles[type]);
            }
            break;

        case 'error':
            // –û—à–∏–±–∫–∞
            if (typeof notificationError !== 'undefined') {
                notificationError(message, titles[type]);
            } else {
                toastr.error(message, titles[type]);
            }
            break;

        default:
            if (typeof notificationInfo !== 'undefined') {
                notificationInfo(message, titles[type] || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
            } else {
                toastr.info(message, titles[type] || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
            }
    }
}

function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initDetailGallery();
    initModalGallery();
    initFavoriteSystem();

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    const style = document.createElement('style');
    style.textContent = `
        .rotate {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}