{% extends 'base.html' %}
{% load static %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ - –°–µ–ª–∏–±—Ä–∏{% endblock %}

{% block content %}
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="ri-robot-line me-2"></i>
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ Avito
                    </h4>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="refreshStats()">
                            <i class="ri-refresh-line me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="resetParserStats()">
                            <i class="ri-restart-line me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportParserData()">
                            <i class="ri-download-line me-1"></i>–≠–∫—Å–ø–æ—Ä—Ç
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-0">
                        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞ Avito. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –∏ –Ω–∞—Ö–æ–¥–∏—Ç–µ –ª—É—á—à–∏–µ —Å–¥–µ–ª–∫–∏.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ri-speed-line me-2"></i>–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="speed-indicator">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="speed-label">–¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:</span>
                            <span class="speed-value" id="current-speed">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>

                        <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —Ä–æ–±–æ—Ç–æ–º -->
                        <div class="speed-progress-container">
                            <div class="progress speed-progress" style="height: 30px; border-radius: 15px;">
                                <div class="progress-bar speed-progress-bar" role="progressbar"
                                     style="width: 0%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);">
                                </div>
                            </div>
                            <div class="speed-labels d-flex justify-content-between mt-2">
                                <small class="text-success">üêå –ú–µ–¥–ª–µ–Ω–Ω–æ</small>
                                <small class="text-warning">‚ö° –°—Ä–µ–¥–Ω–µ</small>
                                <small class="text-danger">üöÄ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è</small>
                            </div>
                        </div>

                        <!-- –î–µ—Ç–∞–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ -->
                        <div class="row mt-3 text-center">
                            <div class="col-md-3">
                                <div class="speed-metric">
                                    <h4 class="text-info mb-0" id="avg-cycle-time">0—Å</h4>
                                    <small class="text-muted">–°—Ä–µ–¥–Ω–∏–π —Ü–∏–∫–ª</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="speed-metric">
                                    <h4 class="text-success mb-0" id="successful-searches">0</h4>
                                    <small class="text-muted">–£—Å–ø–µ—à–Ω—ã–µ –ø–æ–∏—Å–∫–∏</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="speed-metric">
                                    <h4 class="text-warning mb-0" id="success-rate">0%</h4>
                                    <small class="text-muted">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="speed-metric">
                                    <h4 class="text-primary mb-0" id="items-per-hour">0/—á</h4>
                                    <small class="text-muted">–¢–æ–≤–∞—Ä–æ–≤ –≤ —á–∞—Å</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞ -->
    <div class="row mb-4">
        <!-- –í—Å–µ–≥–æ –ø–æ–∏—Å–∫–æ–≤ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="card-title">–í—Å–µ–≥–æ –ø–æ–∏—Å–∫–æ–≤</h5>
                            <h2 class="text-primary mb-0" id="total-searches">0</h2>
                            <small class="text-muted">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤</small>
                        </div>
                        <div class="card-icon">
                            <span class="badge bg-primary rounded p-3">
                                <i class="ri-search-line ri-2x"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="card-title">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤</h5>
                            <h2 class="text-success mb-0" id="items-found">0</h2>
                            <small class="text-muted">—É—Å–ø–µ—à–Ω—ã—Ö –Ω–∞—Ö–æ–¥–æ–∫</small>
                        </div>
                        <div class="card-icon">
                            <span class="badge bg-success rounded p-3">
                                <i class="ri-shopping-bag-line ri-2x"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –•–æ—Ä–æ—à–∏–µ —Å–¥–µ–ª–∫–∏ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="card-title">–•–æ—Ä–æ—à–∏–µ —Å–¥–µ–ª–∫–∏</h5>
                            <h2 class="text-warning mb-0" id="good-deals">0</h2>
                            <small class="text-muted">–ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</small>
                        </div>
                        <div class="card-icon">
                            <span class="badge bg-warning rounded p-3">
                                <i class="ri-trophy-line ri-2x"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="card-info">
                            <h5 class="card-title">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</h5>
                            <h2 class="text-info mb-0" id="duplicates-blocked">0</h2>
                            <small class="text-muted">–¥—É–±–ª–∏–∫–∞—Ç–æ–≤</small>
                        </div>
                        <div class="card-icon">
                            <span class="badge bg-info rounded p-3">
                                <i class="ri-shield-check-line ri-2x"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ri-file-list-line me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <div class="border-end">
                                <h4 class="text-success mb-0" id="active-queries">0</h4>
                                <small class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã–µ</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <h4 class="text-danger mb-0" id="error-count">0</h4>
                                <small class="text-muted">–û—à–∏–±–∫–∏</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <h4 class="text-primary mb-0" id="total-processed">0</h4>
                            <small class="text-muted">–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</small>
                        </div>
                    </div>

                    <h6 class="mb-3">–¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:</h6>
                    <div id="current-queries">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ri-dashboard-line me-2"></i>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º:</h6>
                        <div id="efficiency-distribution">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info mb-0" id="efficiency-rate">0%</h4>
                            <small class="text-muted">–û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning mb-0" id="duplicate-rate">0%</h4>
                            <small class="text-muted">–î—É–±–ª–∏–∫–∞—Ç—ã</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ri-trophy-line me-2"></i>–°–∞–º—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–ó–∞–ø—Ä–æ—Å</th>
                                    <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                                    <th>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</th>
                                    <th>–•–æ—Ä–æ—à–∏–µ —Å–¥–µ–ª–∫–∏</th>
                                    <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                </tr>
                            </thead>
                            <tbody id="successful-queries">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ri-line-chart-line me-2"></i>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary" id="uptime">0—á 0–º</h3>
                                <small class="text-muted">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success" id="avg-success-rate">0%</h3>
                                <small class="text-muted">–°—Ä–µ–¥–Ω—è—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-info" id="total-cycles">0</h3>
                                <small class="text-muted">–í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="ri-information-line me-2"></i>
                        <strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç Avito –ø–æ –≤–∞—à–∏–º –∑–∞–ø—Ä–æ—Å–∞–º,
                        —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–∞—à–∏–Ω–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è –∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–∞–º—ã–µ –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
                        –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç —Å –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å–¥–µ–ª–∫–æ–π!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
function refreshStats() {
    showLoading();

    // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ API endpoints –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞
    const apiEndpoints = [
        '/api/parser-stats/',
        '/api/parser_stats/',
        '/api/parser/'
    ];

    let currentEndpoint = 0;

    function tryNextEndpoint() {
        if (currentEndpoint >= apiEndpoints.length) {
            // –í—Å–µ endpoints –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            console.error('‚ùå –í—Å–µ API endpoints –ø–∞—Ä—Å–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            showDemoData();
            hideLoading();
            return;
        }

        const endpoint = apiEndpoints[currentEndpoint];
        console.log(`üîç –ü—Ä–æ–±—É–µ–º endpoint –ø–∞—Ä—Å–µ—Ä–∞: ${endpoint}`);

        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω—ã:", data);
                if (data.status === 'success' || data.stats) {
                    updateParserStats(data);
                    updateSpeedIndicator(data);
                    hideLoading();
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Å–µ—Ä–∞');
                }
            })
            .catch(error => {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${endpoint}:`, error);
                currentEndpoint++;
                tryNextEndpoint();
            });
    }

    tryNextEndpoint();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞
function updateSpeedIndicator(data) {
    const stats = data.stats || {};

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ —Ü–∏–∫–ª–∞
    const avgCycleTime = stats.avg_cycle_time || '0—Å';
    const successfulSearches = stats.successful_searches || 0;
    const totalSearches = stats.total_searches || 1;
    const itemsFound = stats.items_found || 0;

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ä–µ–º—è —Ü–∏–∫–ª–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    let speedPercentage;
    let speedText;
    let speedClass;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∏–ø–∞ "45—Å"
    const cycleTimeValue = parseInt(avgCycleTime) || 100;

    if (cycleTimeValue < 30) {
        // –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (<30—Å)
        speedPercentage = 85 + (Math.random() * 15); // 85-100%
        speedText = "üöÄ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è";
        speedClass = "text-danger";
    } else if (cycleTimeValue < 60) {
        // –ë—ã—Å—Ç—Ä–æ (30-60—Å)
        speedPercentage = 60 + (Math.random() * 25); // 60-85%
        speedText = "‚ö° –í—ã—Å–æ–∫–∞—è";
        speedClass = "text-warning";
    } else if (cycleTimeValue < 120) {
        // –°—Ä–µ–¥–Ω–µ (1-2 –º–∏–Ω—É—Ç—ã)
        speedPercentage = 30 + (Math.random() * 30); // 30-60%
        speedText = "üìä –°—Ä–µ–¥–Ω—è—è";
        speedClass = "text-info";
    } else {
        // –ú–µ–¥–ª–µ–Ω–Ω–æ (>2 –º–∏–Ω—É—Ç)
        speedPercentage = 10 + (Math.random() * 20); // 10-30%
        speedText = "üêå –ú–µ–¥–ª–µ–Ω–Ω–∞—è";
        speedClass = "text-success";
    }

    // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
    const successRate = Math.round((successfulSearches / totalSearches) * 100);
    const itemsPerHour = Math.round(itemsFound * (3600 / cycleTimeValue));

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('current-speed').textContent = speedText;
    document.getElementById('current-speed').className = `speed-value ${speedClass}`;

    document.getElementById('avg-cycle-time').textContent = avgCycleTime;
    document.getElementById('successful-searches').textContent = successfulSearches;
    document.getElementById('success-rate').textContent = `${successRate}%`;
    document.getElementById('items-per-hour').textContent = `${itemsPerHour}/—á`;

    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ —Ä–æ–±–æ—Ç–∞
    animateSpeedProgress(speedPercentage);
}

// –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
function animateSpeedProgress(targetPercentage) {
    const progressBar = document.querySelector('.speed-progress-bar');

    let currentPercentage = parseInt(progressBar.style.width) || 0;
    const startTime = Date.now();
    const duration = 1500;

    function updateAnimation() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å easing
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        const newPercentage = currentPercentage + (targetPercentage - currentPercentage) * easedProgress;

        progressBar.style.width = `${newPercentage}%`;

        if (progress < 1) {
            requestAnimationFrame(updateAnimation);
        }
    }

    updateAnimation();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –ø–∞—Ä—Å–µ—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function updateParserStats(data) {
    const stats = data.stats || {};
    const history = data.history || [];

    console.log("üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä–∞:", data);

    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    document.getElementById('total-searches').textContent = stats.total_searches || 0;
    document.getElementById('items-found').textContent = stats.items_found || 0;
    document.getElementById('good-deals').textContent = stats.good_deals_found || 0;
    document.getElementById('duplicates-blocked').textContent = stats.duplicates_blocked || 0;

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
    document.getElementById('active-queries').textContent = stats.active_queries || 0;
    document.getElementById('error-count').textContent = stats.error_count || 0;
    document.getElementById('total-processed').textContent = stats.total_searches || 0;

    // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    const efficiencyRate = Math.round(((stats.items_found || 0) / (stats.total_searches || 1)) * 100);
    const duplicateRate = Math.round(((stats.duplicates_blocked || 0) / ((stats.items_found || 0) + (stats.duplicates_blocked || 1))) * 100);

    document.getElementById('efficiency-rate').textContent = `${efficiencyRate}%`;
    document.getElementById('duplicate-rate').textContent = `${duplicateRate}%`;

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    document.getElementById('uptime').textContent = stats.uptime || '0—á 0–º';
    document.getElementById('avg-success-rate').textContent = `${Math.round((stats.successful_searches || 0) / (stats.total_searches || 1) * 100)}%`;
    document.getElementById('total-cycles').textContent = Math.round((stats.total_searches || 0) / (stats.active_queries || 1));

    // –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    updateCurrentQueries(stats.current_queries || []);

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    updateEfficiencyDistribution(stats.efficiency_distribution || []);

    // –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    updateSuccessfulQueries(stats.successful_queries || []);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
function showDemoData() {
    const demoData = {
        stats: {
            total_searches: 1250,
            successful_searches: 980,
            items_found: 345,
            good_deals_found: 89,
            duplicates_blocked: 567,
            active_queries: 8,
            error_count: 23,
            avg_cycle_time: '45—Å',
            uptime: '12—á 30–º',
            current_queries: [
                {name: 'iPhone 13', count: 45, success_rate: 85},
                {name: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ RTX', count: 32, success_rate: 78},
                {name: '–ü—É–ª—å—Ç Haier', count: 28, success_rate: 92}
            ],
            efficiency_distribution: [
                {category: 'üöÄ –í—ã—Å–æ–∫–∞—è (>80%)', count: 120},
                {category: 'üìä –°—Ä–µ–¥–Ω—è—è (50-80%)', count: 450},
                {category: 'üêå –ù–∏–∑–∫–∞—è (<50%)', count: 250}
            ],
            successful_queries: [
                {name: '–ü—É–ª—å—Ç Haier', success_rate: 95, total_found: 200, good_deals: 45},
                {name: 'iPhone 13 Pro', success_rate: 88, total_found: 150, good_deals: 32},
                {name: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ RTX 3060', success_rate: 82, total_found: 180, good_deals: 28}
            ]
        }
    };

    updateParserStats(demoData);
    updateSpeedIndicator(demoData);

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning mt-3';
    alertDiv.innerHTML = `
        <i class="ri-alert-line me-2"></i>
        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ. API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
    `;
    document.querySelector('.card-body').appendChild(alertDiv);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
function updateCurrentQueries(queries) {
    const container = document.getElementById('current-queries');

    if (queries.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</p>';
        return;
    }

    let html = '';
    queries.slice(0, 5).forEach(query => {
        const successPercent = Math.round(query.success_rate || 0);
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-truncate" style="max-width: 150px;">${query.name || query.query}</span>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">${query.count || query.analyses}</span>
                    <small class="text-muted">${successPercent}%</small>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function updateEfficiencyDistribution(distribution) {
    const container = document.getElementById('efficiency-distribution');

    if (distribution.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
    }

    let html = '';
    distribution.forEach(dist => {
        html += `
            <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                    <small>${dist.category || dist.range}</small>
                    <small class="text-muted">${dist.count || dist.queries} –∑–∞–ø—Ä–æ—Å–æ–≤</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar"
                         style="width: ${(dist.count / distribution.reduce((sum, d) => sum + (d.count || d.queries), 0)) * 100}%">
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
function updateSuccessfulQueries(queries) {
    const container = document.getElementById('successful-queries');

    if (queries.length === 0) {
        container.innerHTML = '<tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    let html = '';
    queries.forEach(query => {
        const progressPercent = query.success_rate || query.efficiency;
        html += `
            <tr>
                <td>
                    <strong>${query.name || query.query}</strong>
                </td>
                <td>
                    <span class="badge bg-success">${progressPercent}%</span>
                </td>
                <td>${query.total_found || query.found_items}</td>
                <td>${query.good_deals || query.profitable_items}</td>
                <td>
                    <div class="progress" style="height: 6px; width: 100px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: ${progressPercent}%">
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });

    container.innerHTML = html;
}

// –°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
function resetParserStats() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä—Å–µ—Ä–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }

    showLoading();

    const endpoints = [
        '/api/reset-parser-stats/',
        '/api/reset_parser_stats/',
        '/api/parser/reset/'
    ];

    function tryResetEndpoint(index) {
        if (index >= endpoints.length) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É. –í—Å–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
            hideLoading();
            return;
        }

        fetch(endpoints[index], {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showSuccess(data.message || '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
                refreshStats();
            } else {
                throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${endpoints[index]}:`, error);
            tryResetEndpoint(index + 1);
        })
        .finally(() => {
            hideLoading();
        });
    }

    tryResetEndpoint(0);
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Å–µ—Ä–∞
function exportParserData() {
    showLoading();

    const endpoints = [
        '/api/parser-data/export/',
        '/api/parser_data/export/',
        '/api/parser/export/'
    ];

    function tryExportEndpoint(index) {
        if (index >= endpoints.length) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –í—Å–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
            hideLoading();
            return;
        }

        fetch(endpoints[index], {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showSuccess(data.message || '–î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞
                if (data.download_url) {
                    window.open(data.download_url, '_blank');
                }
            } else {
                throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        })
        .catch(error => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${endpoints[index]}:`, error);
            tryExportEndpoint(index + 1);
        })
        .finally(() => {
            hideLoading();
        });
    }

    tryExportEndpoint(0);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showLoading() {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
}

function hideLoading() {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = false);
}

function showSuccess(message) {
    alert('‚úÖ ' + message);
}

function showError(message) {
    alert('‚ùå ' + message);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(refreshStats, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    refreshStats();
    startAutoRefresh();

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.card-title {
    color: #566a7f;
    font-weight: 600;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}

.badge {
    font-size: 0.75em;
}

.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–∞—Ä—Å–µ—Ä–∞ */
.speed-progress-container {
    position: relative;
    margin: 20px 0;
}

.speed-progress {
    background: #f0f0f0;
    overflow: visible;
}

.speed-progress-bar {
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.speed-label {
    font-weight: 600;
    color: #566a7f;
}

.speed-value {
    font-weight: 700;
    font-size: 1.1em;
}

.speed-metric {
    padding: 10px;
}

.speed-metric h4 {
    font-weight: 700;
}

.speed-labels small {
    font-weight: 600;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .speed-progress-container {
        margin: 15px 0;
    }

    .robot-icon {
        font-size: 1.2rem;
    }

    .speed-metric h4 {
        font-size: 1.1rem;
    }
}
</style>
{% endblock %}