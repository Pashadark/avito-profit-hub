{% load custom_filters %}
{% load humanize %}

<div class="product-card-modern" data-item-id="{{ item.id }}">
    <!-- ГАЛЕРЕЯ -->
    <div class="modern-gallery-container">
        <div class="modern-gallery-track">
            <div class="modern-gallery-slide">
                {% if item.photo or item.image_url %}
                    <img src="{{ item.photo|default:item.image_url }}" class="modern-gallery-image" alt="{{ item.title|default:item.name }}" loading="lazy">
                {% else %}
                    <div class="image-placeholder text-center text-muted">
                        <i class="ri-car-line ri-2x mb-2 opacity-50"></i>
                        <p class="mb-0 small opacity-75">Нет фото</p>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if item.profit and item.profit > 0 %}
            <div class="profit-badge">
                <i class="ri-trending-up-fill me-1"></i>
                +{{ item.profit|intcomma }} ₽
            </div>
        {% elif item.profit and item.profit < 0 %}
            <div class="profit-badge" style="background: linear-gradient(135deg, rgba(255, 71, 87, 0.9), rgba(220, 53, 69, 0.9));">
                <i class="ri-trending-down-fill me-1"></i>
                {{ item.profit|abs_value|intcomma }} ₽
            </div>
        {% endif %}
    </div>

    <!-- ТЕЛО КАРТОЧКИ -->
    <div class="modern-card-body" onclick="window.location.href='{{ item.url }}'">
        <!-- ЗАГОЛОВОК -->
        <h6 class="modern-title">{{ item.title|default:item.name|default:"Без названия" }}</h6>

        <!-- БЕЙДЖИ ИСТОЧНИКА, РЕЙТИНГА И ПРОДАВЦА -->
        <div class="d-flex align-items-center gap-2 mb-2">
            {% if item.source == 'auto_ru' %}
                <div class="source-badge source-auto-ru" title="Auto.ru">
                    <i class="ri-car-fill" style="font-size: 12px;"></i>
                    <span>Auto.ru</span>
                </div>
            {% elif item.source == 'avito' %}
                <div class="source-badge source-avito" title="Авито">
                    <i class="ri-home-4-fill" style="font-size: 12px;"></i>
                    <span>Авито</span>
                </div>
            {% endif %}

            {% if item.seller_rating and item.seller_rating > 0 %}
                <div class="modern-rating">
                    <i class="ri-star-fill text-warning" style="font-size: 12px;"></i>
                    <span class="fw-semibold">{{ item.seller_rating|floatformat:1|replace:".","," }}</span>
                </div>
            {% endif %}

            {% if item.seller_type == 'Компания' or item.seller_type == 'Магазин' %}
                <span class="seller-badge reseller">
                    <i class="ri-store-2-line"></i>{{ item.seller_type }}
                </span>
            {% else %}
                <span class="seller-badge private">
                    <i class="ri-user-line"></i>{{ item.seller_type|default:"Частное лицо" }}
                </span>
            {% endif %}
        </div>

        <!-- ЦЕНЫ И ПРИБЫЛЬ -->
        <div class="price-section mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="current-price">
                    {{ item.price|intcomma }} ₽
                </div>
                {% if item.target_price and item.target_price > 0 %}
                    <div class="target-price">
                        цель {{ item.target_price|intcomma }} ₽
                    </div>
                {% endif %}
            </div>

            <!-- Для Авито - прибыль/убыток -->
            {% if item.source == 'avito' %}
                {% if item.profit and item.profit > 0 %}
                    <div class="price-status price-fair">
                        <i class="ri-arrow-up-line me-1"></i>
                        Прибыль: +{{ item.profit|intcomma }} ₽
                    </div>
                {% elif item.profit and item.profit < 0 %}
                    <div class="price-status price-high">
                        <i class="ri-arrow-down-line me-1"></i>
                        Убыток: {{ item.profit|abs_value|intcomma }} ₽
                    </div>
                {% endif %}
            {% endif %}

            <!-- Для Auto.ru - статус цены -->
            {% if item.source == 'auto_ru' and item.price_status %}
                {% if 'Выше' in item.price_status or 'Above' in item.price_status %}
                    <div class="price-status price-high">
                        <i class="ri-arrow-up-line me-1"></i>
                        {{ item.price_status }}
                    </div>
                {% elif 'Ниже' in item.price_status or 'Below' in item.price_status %}
                    <div class="price-status price-fair">
                        <i class="ri-arrow-down-line me-1"></i>
                        {{ item.price_status }}
                    </div>
                {% elif 'Справедливая' in item.price_status or 'Fair' in item.price_status %}
                    <div class="price-status price-low">
                        <i class="ri-check-line me-1"></i>
                        {{ item.price_status }}
                    </div>
                {% else %}
                    <div class="price-status">
                        <i class="ri-information-line me-1"></i>
                        {{ item.price_status }}
                    </div>
                {% endif %}
            {% endif %}

            <!-- Для других источников или процента прибыли -->
            {% if item.profit_percent and item.profit_percent > 0 and not item.price_status and item.source != 'avito' %}
                <div class="price-status price-fair">
                    <i class="ri-arrow-up-line me-1"></i>
                    Прибыль: +{{ item.profit_percent }}%
                </div>
            {% endif %}
        </div>

        <!-- БЛОК ПРОДАВЦА С АВАТАРОМ И РЕЙТИНГОМ -->
        {% if item.seller_name or item.seller_rating %}
        <div class="seller-rating-sidebar">
            <div class="seller-avatar">
                {% if item.seller_avatar and item.seller_avatar != 'null' and item.seller_avatar.strip %}
                    <img src="{{ item.seller_avatar }}" alt="Аватар продавца" onerror="this.src='/static/assets/img/avatars/1.png'" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <img src="/static/assets/img/avatars/1.png" alt="Аватар продавца" style="width: 100%; height: 100%; object-fit: cover;">
                {% endif %}
            </div>
            <div class="seller-info-sidebar">
                {% if item.seller_rating and item.seller_rating > 0 %}
                <div class="seller-rating-row">
                    <!-- ЗВЕЗДЫ РЕЙТИНГА -->
                    <div class="seller-rating-stars">
                        {% with rating=item.seller_rating %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating|floatformat:0|add:"0" %}
                                    <i class="ri-star-fill text-warning" style="font-size: 13px;"></i>
                                {% elif forloop.counter == rating|floatformat:0|add:"1" and rating|floatformat:1|slice:"-1:" != "0" %}
                                    <i class="ri-star-half-line text-warning" style="font-size: 13px;"></i>
                                {% else %}
                                    <i class="ri-star-line text-warning" style="font-size: 13px;"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>

                    <!-- РЕЙТИНГ РЯДОМ СО ЗВЕЗДАМИ -->
                    <div class="seller-rating-value">
                        {{ item.seller_rating|floatformat:1|replace:".","," }}
                    </div>
                </div>
                {% endif %}

                <!-- ВТОРАЯ СТРОКА: ИМЯ ПРОДАВЦА -->
                {% if item.seller_name %}
                <div class="seller-name-row">
                    <div class="seller-name">{{ item.seller_name }}</div>
                    {% if item.reviews_count and item.reviews_count > 0 %}
                        <div class="seller-reviews">
                            ({{ item.reviews_count }}
                            {% if item.reviews_count == 1 %}отзыв
                            {% elif item.reviews_count < 5 %}отзыва
                            {% else %}отзывов{% endif %})
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- ОСНОВНЫЕ ХАРАКТЕРИСТИКИ -->
        <div class="modern-details-grid">
            {% if item.category %}
                <div class="detail-item">
                    <i class="ri-price-tag-3-line"></i>
                    <span class="detail-text">{{ item.category }}</span>
                </div>
            {% endif %}

            {% if item.city %}
                <div class="detail-item">
                    <i class="ri-map-pin-line"></i>
                    <span class="detail-text">{{ item.city }}</span>
                </div>
            {% endif %}

            {% if item.year %}
                <div class="detail-item">
                    <i class="ri-calendar-line"></i>
                    <span class="detail-text">{{ item.year }} год</span>
                </div>
            {% endif %}

            {% if item.mileage %}
                <div class="detail-item">
                    <i class="ri-roadster-line"></i>
                    <span class="detail-text">{{ item.mileage }}</span>
                </div>
            {% endif %}

            {% if item.color %}
                <div class="detail-item">
                    <i class="ri-palette-line"></i>
                    <span class="detail-text">{{ item.color }}</span>
                </div>
            {% endif %}

            {% if item.product_id %}
                <div class="detail-item">
                    <i class="ri-hashtag"></i>
                    <span class="detail-text">ID: {{ item.product_id }}</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ФУТЕР С ДАТОЙ -->
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <div class="time-info">
                <small class="text-muted">{{ item.found_at|default:"Дата не указана" }}</small>
            </div>
            <div class="action-buttons">
                <a href="{{ item.url }}" target="_blank"
                   class="modern-btn modern-btn-primary"
                   onclick="event.stopPropagation()"
                   title="Открыть на сайте">
                    <i class="ri-external-link-line"></i>
                </a>
                <button class="modern-btn modern-btn-danger favorite-btn"
                        data-item-id="{{ item.id }}"
                        data-is-favorite="{% if item.is_favorite %}true{% else %}false{% endif %}"
                        onclick="event.stopPropagation(); toggleFavorite({{ item.id }}, {% if item.is_favorite %}true{% else %}false{% endif %}, this)"
                        title="{% if item.is_favorite %}Удалить из избранного{% else %}Добавить в избранное{% endif %}">
                    <i class="{% if item.is_favorite %}ri-heart-fill{% else %}ri-heart-line{% endif %}"></i>
                </button>
            </div>
        </div>
    </div>
</div>