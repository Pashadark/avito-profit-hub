{% extends 'base.html' %}
{% load static %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ML –º–æ–¥–µ–ª–∏ - –°–µ–ª–∏–±—Ä–∏{% endblock %}

{% block content %}
<!-- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
    .container-xxl.flex-grow-1.container-p-y {
        max-width: 1800px !important;
        margin: 0 auto !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
        width: 100% !important;
    }

    @media (max-width: 1800px) {
        .container-xxl.flex-grow-1.container-p-y {
            max-width: 100% !important;
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
        }
    }

    @media (max-width: 768px) {
        .container-xxl.flex-grow-1.container-p-y {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    .row {
        margin-left: -0.75rem !important;
        margin-right: -0.75rem !important;
    }

    .col-12, .col-xl-3, .col-md-6, .col-lg-6 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞ */
    .quality-indicator {
        position: relative;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .quality-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease-in-out;
    }

    .quality-excellent { background: linear-gradient(90deg, #28a745, #20c997); }
    .quality-good { background: linear-gradient(90deg, #20c997, #ffc107); }
    .quality-average { background: linear-gradient(90deg, #ffc107, #fd7e14); }
    .quality-poor { background: linear-gradient(90deg, #fd7e14, #dc3545); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ */
    .intelligence-progress-container {
        position: relative;
        margin: 20px 0;
    }

    .intelligence-progress {
        background: #f0f0f0;
        overflow: visible;
        height: 30px;
        border-radius: 15px;
    }

    .intelligence-progress-bar {
        transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        background: linear-gradient(90deg, #dc3545, #fd7e14, #ffc107, #20c997, #28a745);
        border-radius: 15px;
    }

    .brain-indicator {
        position: absolute;
        top: -12px;
        transform: translateX(-50%);
        transition: left 2s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
    }

    .brain-icon {
        font-size: 1.8rem;
    }

    .intelligence-label {
        font-weight: 600;
        color: #566a7f;
    }

    .intelligence-value {
        font-weight: 700;
        font-size: 1.1em;
    }

    .intelligence-metric {
        padding: 10px;
    }

    .intelligence-metric h4 {
        font-weight: 700;
    }

    .intelligence-labels small {
        font-weight: 600;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }

    .card-title {
        color: #566a7f;
        font-weight: 600;
    }

    .progress {
        border-radius: 10px;
    }

    .progress-bar {
        border-radius: 10px;
    }

    .badge {
        font-size: 0.75em;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .intelligence-progress-container {
            margin: 15px 0;
        }

        .brain-icon {
            font-size: 1.5rem;
        }

        .intelligence-metric h4 {
            font-size: 1.2rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 5px;
        }

        .btn-group .btn {
            margin-bottom: 5px;
        }
    }
</style>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999"></div>

<div class="row">
    <div class="col-12">
        <!-- –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç –º–æ–¥–µ–ª–∏ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="ri-brain-line me-2"></i>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç ML –º–æ–¥–µ–ª–∏
                        </h5>
                        <div class="ms-auto">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm" onclick="testModel()">
                                    <i class="ri-test-tube-line me-1"></i>–¢–µ—Å—Ç –º–æ–¥–µ–ª–∏
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="retrainModel()">
                                    <i class="ri-refresh-line me-1"></i>–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="refreshMLStats()">
                                    <i class="ri-refresh-line me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="intelligence-indicator">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="intelligence-label">–£—Ä–æ–≤–µ–Ω—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞:</span>
                                <span class="intelligence-value text-primary" id="intelligence-level">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>

                            <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –º–æ–∑–≥–æ–º -->
                            <div class="intelligence-progress-container">
                                <div class="progress intelligence-progress">
                                    <div class="progress-bar intelligence-progress-bar" role="progressbar" style="width: 0%">
                                    </div>
                                </div>
                                <div class="intelligence-labels d-flex justify-content-between mt-2">
                                    <small class="text-danger">üéØ –ù–∞—á–∞–ª—å–Ω—ã–π</small>
                                    <small class="text-warning">ü§ñ –°—Ä–µ–¥–Ω–∏–π</small>
                                    <small class="text-success">üß† –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</small>
                                </div>
                            </div>

                            <!-- –î–µ—Ç–∞–ª–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ -->
                            <div class="row mt-3 text-center">
                                <div class="col-md-3">
                                    <div class="intelligence-metric">
                                        <h4 class="text-info mb-0" id="model-accuracy">0%</h4>
                                        <small class="text-muted">üéØ –¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="intelligence-metric">
                                        <h4 class="text-success mb-0" id="training-samples">0</h4>
                                        <small class="text-muted">üß† –û–±—Ä–∞–∑—Ü–æ–≤ –æ–±—É—á–µ–Ω–∏—è</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="intelligence-metric">
                                        <h4 class="text-warning mb-0" id="feature-count">0</h4>
                                        <small class="text-muted">üé≤ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—á</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="intelligence-metric">
                                        <h4 class="text-primary mb-0" id="learning-progress">0%</h4>
                                        <small class="text-muted">üìö –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ML –º–æ–¥–µ–ª–∏ -->
        <div class="row mb-4">
            <!-- –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="card-info">
                                <h5 class="card-title">–¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</h5>
                                <h2 class="text-primary mb-0" id="prediction-accuracy">0%</h2>
                                <small class="text-muted">R¬≤ score –º–æ–¥–µ–ª–∏</small>
                            </div>
                            <div class="card-icon">
                                <span class="badge bg-primary rounded p-3">
                                    <i class="ri-target-line ri-2x"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û–±—É—á–µ–Ω–æ –º–æ–¥–µ–ª–µ–π -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="card-info">
                                <h5 class="card-title">–û–±—É—á–µ–Ω–æ –º–æ–¥–µ–ª–µ–π</h5>
                                <h2 class="text-success mb-0" id="models-trained">0</h2>
                                <small class="text-muted">–∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</small>
                            </div>
                            <div class="card-icon">
                                <span class="badge bg-success rounded p-3">
                                    <i class="ri-cpu-line ri-2x"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="card-info">
                                <h5 class="card-title">–°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞</h5>
                                <h2 class="text-warning mb-0" id="avg-error">0%</h2>
                                <small class="text-muted">MAPE –º–µ—Ç—Ä–∏–∫–∞</small>
                            </div>
                            <div class="card-icon">
                                <span class="badge bg-warning rounded p-3">
                                    <i class="ri-alert-line ri-2x"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="card-info">
                                <h5 class="card-title">–í—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</h5>
                                <h2 class="text-info mb-0" id="prediction-time">0–º—Å</h2>
                                <small class="text-muted">–±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç</small>
                            </div>
                            <div class="card-icon">
                                <span class="badge bg-info rounded p-3">
                                    <i class="ri-timer-flash-line ri-2x"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ri-line-chart-line me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-4">
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-success mb-0" id="successful-predictions">0</h4>
                                    <small class="text-muted">–£—Å–ø–µ—à–Ω—ã–µ</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-danger mb-0" id="failed-predictions">0</h4>
                                    <small class="text-muted">–û—à–∏–±–∫–∏</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <h4 class="text-primary mb-0" id="total-predictions">0</h4>
                                <small class="text-muted">–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</small>
                            </div>
                        </div>

                        <h6 class="mb-3">–ö–∞—á–µ—Å—Ç–≤–æ —Ñ–∏—á–µ–π:</h6>
                        <div id="feature-quality">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ri-dashboard-line me-2"></i>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</h6>
                            <div id="confidence-distribution">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-info mb-0" id="high-confidence">0%</h4>
                                <small class="text-muted">–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-warning mb-0" id="avg-confidence">0%</h4>
                                <small class="text-muted">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –£—Å–ø–µ—à–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ri-trophy-line me-2"></i>–°–∞–º—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                        <th>–¢–æ—á–Ω–æ—Å—Ç—å</th>
                                        <th>–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</th>
                                        <th>–£—Å–ø–µ—à–Ω—ã–µ</th>
                                        <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="successful-categories">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ri-git-repository-line me-2"></i>–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="border rounded p-3">
                                    <h3 class="text-primary" id="model-version">v1.0</h3>
                                    <small class="text-muted">–í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏</small>
                                </div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="border rounded p-3">
                                    <h3 class="text-success" id="data-quality">0%</h3>
                                    <small class="text-muted">–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö</small>
                                </div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="border rounded p-3">
                                    <h3 class="text-info" id="training-cycles">0</h3>
                                    <small class="text-muted">–¶–∏–∫–ª–æ–≤ –æ–±—É—á–µ–Ω–∏—è</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="ri-information-line me-2"></i>
                            <strong>–ö–∞–∫ –º–æ–¥–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É–º–Ω–µ–µ:</strong> –° –∫–∞–∂–¥—ã–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ–º –º–æ–¥–µ–ª—å –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏.
                            –ü–æ—Å–ª–µ 1000+ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Ç–æ—á–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 40-60%, –∞ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è –≤ 10 —Ä–∞–∑!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
// –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ Django
const CSRF_TOKEN = '{{ csrf_token }}';

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function getCsrfToken() {
    return CSRF_TOKEN || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

function showLoading() {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
}

function hideLoading() {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = false);
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function showAlert(message, type) {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();

    document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
        this.remove();
    });
}

function getAccuracyBadgeClass(accuracy) {
    if (accuracy >= 80) return 'bg-success';
    if (accuracy >= 65) return 'bg-info';
    if (accuracy >= 50) return 'bg-warning';
    return 'bg-secondary';
}

function getAccuracyProgressClass(accuracy) {
    if (accuracy >= 80) return 'bg-success';
    if (accuracy >= 65) return 'bg-info';
    if (accuracy >= 50) return 'bg-warning';
    return 'bg-secondary';
}

// ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ==========

async function loadMLData() {
    console.log("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –†–ï–ê–õ–¨–ù–´–• ML –¥–∞–Ω–Ω—ã—Ö...");

    try {
        const response = await fetch('/api/ml-stats/');

        if (!response.ok) {
            console.error(`‚ùå HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
            showRealisticDemoData();
            return;
        }

        const data = await response.json();
        console.log("üìä –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å API:", data);

        if (data.status === 'success') {
            updateAllStats(data);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.warnings && data.warnings.length > 0) {
                showWarnings(data.warnings);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if (data.real_stats) {
                updateRealStats(data.real_stats);
            }
        } else {
            console.error("‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ success:", data);
            showRealisticDemoData();
        }
    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        showRealisticDemoData();
    }
}

function updateAllStats(data) {
    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    if (data.model_stats) {
        const ms = data.model_stats;
        updateElement('prediction-accuracy', `${(ms.prediction_accuracy * 100).toFixed(1)}%`);
        updateElement('training-samples', ms.training_samples?.toLocaleString() || '0');
        updateElement('feature-count', ms.feature_count || '0');
        updateElement('models-trained', ms.models_trained || '1');
        updateElement('avg-error', `${((ms.avg_error || 0) * 100).toFixed(1)}%`);
        updateElement('successful-predictions', ms.successful_predictions?.toLocaleString() || '0');
        updateElement('failed-predictions', ms.failed_predictions?.toLocaleString() || '0');
        updateElement('total-predictions', ms.total_predictions?.toLocaleString() || '0');
        updateElement('model-version', ms.model_version || 'v1.0');
        updateElement('data-quality', `${((ms.data_quality || 0) * 100).toFixed(1)}%`);
        updateElement('training-cycles', ms.training_cycles || '0');
    }

    // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    if (data.performance_stats) {
        const ps = data.performance_stats;
        updateElement('prediction-time', `${ps.avg_prediction_time || 0}–º—Å`);
        updateElement('high-confidence', `${((ps.high_confidence_rate || 0) * 100).toFixed(1)}%`);
        updateElement('avg-confidence', `${((ps.avg_confidence || 0) * 100).toFixed(1)}%`);

        updateConfidenceDistribution(ps.confidence_distribution || []);
    }

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (data.category_stats) {
        updateSuccessfulCategories(data.category_stats.successful_categories || []);
    }

    // –ö–∞—á–µ—Å—Ç–≤–æ —Ñ–∏—á–µ–π
    if (data.feature_quality) {
        updateFeatureQuality(data.feature_quality);
    }

    updateIntelligenceIndicator(data);
}

function updateFeatureQuality(features) {
    const container = document.getElementById('feature-quality');
    if (!container) return;

    if (features.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏—á–∞—Ö</p>';
        return;
    }

    let html = '';
    features.forEach(feature => {
        const qualityPercent = Math.round(feature.quality * 100);
        let qualityClass = 'quality-excellent';
        if (qualityPercent < 60) qualityClass = 'quality-poor';
        else if (qualityPercent < 75) qualityClass = 'quality-average';
        else if (qualityPercent < 90) qualityClass = 'quality-good';

        html += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-truncate" style="max-width: 150px;">${feature.name}</span>
                    <small class="text-muted">${qualityPercent}%</small>
                </div>
                <div class="quality-indicator">
                    <div class="quality-fill ${qualityClass}" style="width: ${qualityPercent}%"></div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updateConfidenceDistribution(distribution) {
    const container = document.getElementById('confidence-distribution');
    if (!container) return;

    if (distribution.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
    }

    let html = '';
    const total = distribution.reduce((sum, d) => sum + d.count, 0);

    distribution.forEach(dist => {
        const percentage = Math.round((dist.count / total) * 100);
        html += `
            <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                    <small>${dist.range || dist.category}</small>
                    <small class="text-muted">${dist.count} (${percentage}%)</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updateSuccessfulCategories(categories) {
    const container = document.getElementById('successful-categories');
    if (!container) return;

    if (categories.length === 0) {
        container.innerHTML = '<tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö</td></tr>';
        return;
    }

    let html = '';
    categories.forEach(cat => {
        const accuracy = cat.accuracy || 50;
        const badgeClass = getAccuracyBadgeClass(accuracy);
        const progressClass = getAccuracyProgressClass(accuracy);

        html += `
            <tr>
                <td><strong>${cat.name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</strong></td>
                <td><span class="badge ${badgeClass}">${accuracy}%</span></td>
                <td>${cat.total_predictions || 0}</td>
                <td>${cat.successful || 0}</td>
                <td>
                    <div class="progress" style="height: 8px; width: 120px;">
                        <div class="progress-bar ${progressClass}"
                             role="progressbar"
                             style="width: ${Math.min(accuracy, 100)}%"
                             title="–°—Ä–µ–¥–Ω—è—è ML –æ—Ü–µ–Ω–∫–∞: ${cat.avg_ml || 0}">
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });

    container.innerHTML = html;
}

function updateRealStats(stats) {
    console.log("üìà –†–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", stats);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª—è—Ö –µ—Å–ª–∏ –µ—Å—Ç—å
    if (stats.model_versions && stats.model_versions.length > 0) {
        let existingAlert = document.querySelector('.model-info-alert');
        if (!existingAlert) {
            const modelInfo = document.createElement('div');
            modelInfo.className = 'alert alert-info mt-3 model-info-alert';
            modelInfo.innerHTML = `
                <strong>üîÑ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</strong>
                <ul class="mb-0 mt-2">
                    ${stats.model_versions.map(m =>
                        `<li><strong>${m.version}</strong> (${m.size_kb} KB)</li>`
                    ).join('')}
                </ul>
            `;

            const container = document.querySelector('.alert.alert-info.mt-3');
            if (container) {
                container.parentNode.insertBefore(modelInfo, container);
            }
        }
    }
}

function showWarnings(warnings) {
    const container = document.querySelector('.toast-container');

    warnings.forEach(warning => {
        const type = warning.type || 'warning';
        const toastId = 'warning-' + Date.now() + Math.random();

        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'info' ? 'info' : 'warning'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${type === 'info' ? '‚ÑπÔ∏è' : '‚ö†Ô∏è'}</strong> ${warning.message}
                        ${warning.suggestion ? `<br><small>${warning.suggestion}</small>` : ''}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', toastHTML);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();

        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    });
}

function updateIntelligenceIndicator(data) {
    const ms = data.model_stats || {};
    const accuracy = ms.prediction_accuracy || 0;
    const trainingSamples = ms.training_samples || 0;

    let intelligencePercentage, intelligenceText, intelligenceClass;

    if (accuracy > 0.8 && trainingSamples > 1000) {
        intelligencePercentage = 80 + (Math.random() * 20);
        intelligenceText = "üß† –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π";
        intelligenceClass = "text-success";
    } else if (accuracy > 0.6 && trainingSamples > 500) {
        intelligencePercentage = 50 + (Math.random() * 30);
        intelligenceText = "ü§ñ –°—Ä–µ–¥–Ω–∏–π";
        intelligenceClass = "text-warning";
    } else {
        intelligencePercentage = 20 + (Math.random() * 30);
        intelligenceText = "üéØ –ù–∞—á–∞–ª—å–Ω—ã–π";
        intelligenceClass = "text-danger";
    }

    const learningProgress = Math.min(100, Math.round((trainingSamples / 2000) * 100));

    updateElement('intelligence-level', intelligenceText);
    document.getElementById('intelligence-level').className = `intelligence-value ${intelligenceClass}`;
    updateElement('model-accuracy', `${Math.round(accuracy * 100)}%`);
    updateElement('training-samples', trainingSamples.toLocaleString());
    updateElement('feature-count', ms.feature_count || '0');
    updateElement('learning-progress', `${learningProgress}%`);

    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    animateIntelligenceProgress(intelligencePercentage);
}

function animateIntelligenceProgress(targetPercentage) {
    const progressBar = document.querySelector('.intelligence-progress-bar');

    if (!progressBar) return;

    let currentPercentage = parseInt(progressBar.style.width) || 0;
    const startTime = Date.now();
    const duration = 2000;

    function updateAnimation() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        const newPercentage = currentPercentage + (targetPercentage - currentPercentage) * easedProgress;

        progressBar.style.width = `${newPercentage}%`;

        if (progress < 1) {
            requestAnimationFrame(updateAnimation);
        }
    }

    updateAnimation();
}

function showRealisticDemoData() {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger mt-3';
    alertDiv.innerHTML = `
        <i class="ri-error-warning-line me-2"></i>
        <strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ML –º–æ–¥–µ–ª–∏</strong><br>
        <small>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API endpoint: /api/ml-stats/</small>
    `;
    document.querySelector('.card-body').appendChild(alertDiv);
}

// ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–ï ==========

function testModel() {
    showLoading();

    fetch('/api/ml-test/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            test_samples: 3,
            test_type: 'quick'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            let message = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:<br>';
            if (data.results) {
                data.results.forEach(r => {
                    message += `‚Ä¢ ${r.product}: ${r.freshness} (${r.category})<br>`;
                });
            }
            showSuccess(message);
            refreshMLStats();
        } else {
            throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å: ' + error.message);
    })
    .finally(() => {
        hideLoading();
    });
}

function retrainModel() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) {
        return;
    }

    showLoading();

    fetch('/api/ml-retrain/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message || '–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∞');
            refreshMLStats();
        } else {
            throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å: ' + error.message);
    })
    .finally(() => {
        hideLoading();
    });
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

function refreshMLStats() {
    loadMLData();
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(loadMLData, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadMLData();
    startAutoRefresh();

    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
});
</script>
{% endblock %}