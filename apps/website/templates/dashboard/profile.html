{% extends 'base.html' %}
{% load static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - ProfitHub{% endblock %}

{% block content %}
<!-- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
    .container-xxl.flex-grow-1.container-p-y {
        max-width: 1800px !important;
        margin: 0 auto !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }

    @media (max-width: 1800px) {
        .container-xxl.flex-grow-1.container-p-y {
            max-width: 100% !important;
        }
    }

    @media (max-width: 768px) {
        .container-xxl.flex-grow-1.container-p-y {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
    }
</style>

<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div class="col-xl-4 col-lg-5 col-md-5 order-1 order-md-0">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="card mb-4">
            <div class="card-body pt-4">
                <div class="user-avatar-section">
    <div class="d-flex align-items-center flex-column">
        <img class="img-fluid rounded-3 mb-3"
             src="{% if user_profile.avatar %}/{{ user_profile.avatar }}{% else %}{% static 'assets/img/avatars/1.png' %}{% endif %}"
             height="120"
             width="120"
             alt="User avatar"
             style="object-fit: cover;"
             onerror="this.src='{% static 'assets/img/avatars/1.png' %}'">
        <div class="user-info text-center">
            <h5>{{ request.user.get_full_name|default:request.user.username }}</h5>
            <span class="badge bg-label-primary rounded-pill">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
        </div>
    </div>
</div>
                <div class="d-flex justify-content-around flex-wrap my-4 py-3 border-top border-bottom">
                    <div class="d-flex align-items-center me-3 me-md-4 gap-3">
                        <div class="avatar">
                            <div class="avatar-initial bg-label-primary rounded-3">
                                <i class="ri-check-line ri-lg"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ found_items_count }}</h5>
                            <span>–ù–∞—Ö–æ–¥–æ–∫</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar">
                            <div class="avatar-initial bg-label-primary rounded-3">
                                <i class="ri-briefcase-line ri-lg"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ good_deals_count }}</h5>
                            <span>–í—ã–≥–æ–¥–Ω—ã—Ö</span>
                        </div>
                    </div>
                </div>

                <h5 class="pb-3 border-bottom mb-3">–î–µ—Ç–∞–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h5>
                <div class="info-container">
                    <ul class="list-unstyled mb-4">
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                            <span>{{ request.user.username }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">Email:</span>
                            <span>{{ request.user.email }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–ò–º—è:</span>
                            <span>{{ request.user.first_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–§–∞–º–∏–ª–∏—è:</span>
                            <span>{{ request.user.last_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                            <span>{{ user_profile.phone|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–ü–æ–ª:</span>
                            <span>
                                {% if user_profile.gender == 'male' %}–ú—É–∂—Å–∫–æ–π
                                {% elif user_profile.gender == 'female' %}–ñ–µ–Ω—Å–∫–∏–π
                                {% else %}–ù–µ —É–∫–∞–∑–∞–Ω{% endif %}
                            </span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="badge bg-label-success rounded-pill">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</span>
                            <span class="h5 mb-0 text-primary">{{ user_profile.balance|floatformat:2 }} ‚ÇΩ</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                            <span>{{ request.user.date_joined|date:"d.m.Y" }}</span>
                        </li>
                        <li class="mb-2">
                            <span class="fw-medium text-heading me-2">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</span>
                            <span>{{ request.user.last_login|date:"d.m.Y H:i"|default:"–ù–µ–¥–∞–≤–Ω–æ" }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- /–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    </div>
    <!--/ –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="col-xl-8 col-lg-7 col-md-7 order-0 order-md-1">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <div class="nav-align-top mb-4">
            <ul class="nav nav-pills flex-column flex-md-row mb-3 row-gap-2" role="tablist">
                <li class="nav-item">
                    <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#accountTab" aria-controls="accountTab" aria-selected="true">
                        <i class="ri-user-3-line me-2"></i>–ê–∫–∫–∞—É–Ω—Ç
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#telegramTab" aria-controls="telegramTab" aria-selected="false">
                        <i class="ri-telegram-line me-2"></i>Telegram
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#securityTab" aria-controls="securityTab" aria-selected="false">
                        <i class="ri-lock-2-line me-2"></i>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#paymentsTab" aria-controls="paymentsTab" aria-selected="false">
                        <i class="ri-coin-line me-2"></i>–ü–ª–∞—Ç–µ–∂–∏
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –ê–∫–∫–∞—É–Ω—Ç -->
                <div class="tab-pane fade show active" id="accountTab" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h5>
                        </div>
                        <div class="card-body">
                            <form id="profileForm" method="POST" action="{% url 'website:update_profile' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">–ò–º—è</label>
                                        <input type="text" class="form-control" id="firstName" name="first_name"
                                               value="{{ request.user.first_name }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                        <input type="text" class="form-control" id="lastName" name="last_name"
                                               value="{{ request.user.last_name }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email"
                                               value="{{ request.user.email }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                        <input type="tel" class="form-control" id="phone" name="phone"
                                               value="{{ user_profile.phone|default:'' }}" placeholder="+7 (999) 999-99-99">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–ü–æ–ª</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male"
                                                       {% if user_profile.gender == 'male' %}checked{% endif %}>
                                                <label class="form-check-label" for="genderMale">–ú—É–∂—Å–∫–æ–π</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female"
                                                       {% if user_profile.gender == 'female' %}checked{% endif %}>
                                                <label class="form-check-label" for="genderFemale">–ñ–µ–Ω—Å–∫–∏–π</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="avatar" class="form-label">–ê–≤–∞—Ç–∞—Ä–∫–∞</label>

                                        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ -->
                                        <div class="mb-3 text-center">
                                            <img id="avatarPreview"
                                                 src="{% if user_profile.avatar %}/{{ user_profile.avatar }}{% else %}{% static 'assets/img/avatars/1.png' %}{% endif %}"
                                                 class="rounded-circle border"
                                                 width="100" height="100"
                                                 style="object-fit: cover;"
                                                 alt="–¢–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä">
                                        </div>

                                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*"
                                               onchange="previewAvatar(this)">
                                        <div class="form-text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 200x200 px</div>

                                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –∞–≤–∞—Ç–∞—Ä–µ -->
                                        {% if user_profile.avatar %}
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAvatar()">
                                                <i class="ri-delete-bin-line me-1"></i>–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                                            </button>
                                            <small class="text-muted ms-2">–¢–µ–∫—É—â–∏–π: {{ user_profile.avatar.name }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="ri-save-line me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ Telegram -->
                <div class="tab-pane fade" id="telegramTab" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-telegram-line me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="telegramStatus">
                                <!-- –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ AJAX -->
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="border rounded p-4">
                                        <h6>üì± –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–∏–≤—è–∑–∫–∞</h6>
                                        <button class="btn btn-primary w-100 mb-3" onclick="generateTelegramCode()">
                                            <i class="ri-qr-code-line me-2"></i>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏
                                        </button>

                                        <div id="verificationCode" style="display: none;">
                                            <div class="alert alert-info">
                                                <strong>–ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:</strong>
                                                <h3 id="telegramCode" class="text-center my-3"></h3>
                                                <small>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç</small>
                                            </div>
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" id="codeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤ –±–æ—Ç–µ">
                                                <button class="btn btn-success" onclick="verifyTelegramCode()">
                                                    <i class="ri-check-line"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="border rounded p-4">
                                        <h6>üîó –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã</h6>
                                        <div class="mb-3">
                                            <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ –≤ –±–æ—Ç–µ:</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="botCommand"
                                                       value="/link {{ user.username }}" readonly>
                                                <button class="btn btn-outline-secondary" onclick="copyBotCommand()">
                                                    <i class="ri-file-copy-line"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">–í–∞—à –ª–æ–≥–∏–Ω –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏:</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" value="{{ user.username }}" readonly>
                                                <button class="btn btn-outline-secondary" onclick="copyUsername()">
                                                    <i class="ri-file-copy-line"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4" id="telegramControls" style="display: none;">
                                <div class="col-12">
                                    <div class="border rounded p-3">
                                        <h6>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–æ–π</h6>
                                        <button class="btn btn-outline-danger me-2" onclick="unlinkTelegram()">
                                            <i class="ri-link-unlink-line me-2"></i>–û—Ç–≤—è–∑–∞—Ç—å Telegram
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="testBotConnection()">
                                            <i class="ri-test-tube-line me-2"></i>–¢–µ—Å—Ç —Å–≤—è–∑–∏
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
                <div class="tab-pane fade" id="securityTab" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-lock-2-line me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h6>
                                    <form id="passwordForm">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                            <input type="password" class="form-control" id="currentPassword" name="current_password" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                            <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="changePassword()">
                                            <i class="ri-lock-password-line me-2"></i>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <div class="border rounded p-3">
                                        <h6>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</h6>
                                        <ul class="mb-3">
                                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å</li>
                                            <li>–ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
                                            <li>–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –ø–∞—Ä–æ–ª—å</li>
                                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é</li>
                                        </ul>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                                            <label class="form-check-label" for="twoFactorAuth">
                                                –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –ü–ª–∞—Ç–µ–∂–∏ -->
                <div class="tab-pane fade" id="paymentsTab" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-coin-line me-2"></i>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>–î–∞—Ç–∞</th>
                                            <th>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                                            <th>–°—É–º–º–∞</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in transactions %}
                                        <tr>
                                            <td>{{ transaction.created_at|date:"d.m.Y H:i" }}</td>
                                            <td>{{ transaction.get_transaction_type_display }}</td>
                                            <td class="{% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                                                {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount }} ‚ÇΩ
                                            </td>
                                            <td>
                                                <span class="badge
                                                    {% if transaction.status == 'completed' %}bg-label-success
                                                    {% elif transaction.status == 'pending' %}bg-label-warning
                                                    {% else %}bg-label-danger{% endif %}">
                                                    {{ transaction.get_status_display }}
                                                </span>
                                            </td>
                                            <td>{{ transaction.description }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    </div>
    <!--/ –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="passwordChangeForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" name="new_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" name="confirm_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
        </div>
    </div>
</div>

<style>
.subscription-status {
    background: rgba(105, 108, 255, 0.05);
    border-left: 4px solid #696cff;
}

.avatar-initial {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.user-avatar-section img {
    padding: 3px;
}

.nav-pills .nav-link.active {
    background-color: #696cff;
    border-color: #696cff;
}

.table-hover tbody tr:hover {
    background-color: rgba(105, 108, 255, 0.04);
}

.tab-content {
    min-height: 400px;
}

.info-container ul li {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-container ul li:last-child {
    border-bottom: none;
}

.form-label {
    font-weight: 500;
    margin-bottom: 8px;
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram
function loadTelegramStatus() {
    fetch('/api/telegram/status/')
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            const statusDiv = document.getElementById('telegramStatus');

            if (data.status === 'success' && data.telegram_verified) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="ri-checkbox-circle-line me-2"></i>
                        <strong>Telegram –ø—Ä–∏–≤—è–∑–∞–Ω!</strong>
                        <button class="btn btn-sm btn-outline-success float-end" onclick="testBotConnection()">
                            <i class="ri-test-tube-line me-1"></i>–¢–µ—Å—Ç —Å–≤—è–∑–∏
                        </button>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h6>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                                <p class="mb-1"><small>User ID:</small><br><strong>${data.telegram_user_id}</strong></p>
                                <p class="mb-0"><small>Username:</small><br><strong>@${data.telegram_username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</strong></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h6>üîî –°—Ç–∞—Ç—É—Å</h6>
                                <p class="mb-1"><span class="badge bg-success">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span></p>
                                <p class="mb-0"><span class="badge bg-success">‚úÖ –í–∫–ª—é—á–µ–Ω—ã</span></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h6>‚ö° –î–µ–π—Å—Ç–≤–∏—è</h6>
                                <button class="btn btn-sm btn-outline-danger w-100 mb-2" onclick="unlinkTelegram()">
                                    <i class="ri-link-unlink-line me-1"></i>–û—Ç–≤—è–∑–∞—Ç—å
                                </button>
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="sendTestMessage()">
                                    <i class="ri-send-plane-line me-1"></i>–¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="ri-error-warning-line me-2"></i>
                        <strong>Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω</strong>
                        <p class="mb-0 mt-2">–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –≤–∞—à Telegram –∞–∫–∫–∞—É–Ω—Ç.</p>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="border rounded p-3 bg-light">
                                <h6>üì± –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –∫–æ–¥</h6>
                                <button class="btn btn-primary w-100 mb-2" onclick="generateTelegramCode()">
                                    <i class="ri-qr-code-line me-2"></i>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
                                </button>
                                <small class="text-muted">–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 bg-light">
                                <h6>üîó –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É</h6>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" value="/link {{ user.username }}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyText('/link {{ user.username }}')">
                                        <i class="ri-file-copy-line"></i>
                                    </button>
                                </div>
                                <small class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É</small>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            document.getElementById('telegramStatus').innerHTML = `
                <div class="alert alert-danger">
                    <i class="ri-error-warning-line me-2"></i>
                    <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞</strong>
                    <p class="mb-0 mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                </div>
            `;
        });
}

function generateTelegramCode() {
    showToast('üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥...', 'info');

    fetch('/api/telegram/generate-code/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const modal = new bootstrap.Modal(document.getElementById('codeModal'));
            document.getElementById('generatedCode').textContent = data.code;
            modal.show();

            showToast('‚úÖ –ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
        } else {
            showToast('‚ùå –û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function verifyCodeInBot() {
    const code = document.getElementById('generatedCode').textContent;

    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const instruction = `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:\n\n/verify ${code}\n\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É:`;

    document.getElementById('verificationInstruction').innerHTML = instruction;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('copyCommandBtn').style.display = 'block';
}

function copyVerificationCommand() {
    const code = document.getElementById('generatedCode').textContent;
    const command = `/verify ${code}`;
    copyText(command);
    showToast('‚úÖ –ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –±–æ—Ç—É.', 'success');
}

function testBotConnection() {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º...');
    showToast('üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–≤—è–∑—å —Å –±–æ—Ç–æ–º...', 'info');

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏–∑ –≤–∞—à–∏—Ö urls.py
    fetch('/api/test-bot-connection/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({}) // –ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ, —Ç–∞–∫ –∫–∞–∫ view –Ω–µ –æ–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    })
    .then(response => {
        console.log('üì® –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);

        if (data.status === 'success') {
            showToast('‚úÖ ' + data.message, 'success');
        } else {
            showToast('‚ùå ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
    });
}

function sendTestMessage() {
    showToast('üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...', 'info');

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é —á—Ç–æ –∏ testBotConnection
    testBotConnection();
}

function unlinkTelegram() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å Telegram? –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–∫–ª—é—á–µ–Ω—ã.')) {
        return;
    }

    fetch('/api/telegram/unlink/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('‚úÖ ' + data.message, 'success');
            setTimeout(() => {
                loadTelegramStatus(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å
            }, 1000);
        } else {
            showToast('‚ùå ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
    }).catch(() => {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
    });
}

function showToast(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    const toastId = 'toast-' + Date.now();
    const typeClass = type === 'success' ? 'text-bg-success' :
                     type === 'error' ? 'text-bg-danger' :
                     type === 'warning' ? 'text-bg-warning' : 'text-bg-info';

    const toastHtml = `
        <div id="${toastId}" class="toast ${typeClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ Telegram
document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    const telegramTab = document.querySelector('[data-bs-target="#telegramTab"]');
    if (telegramTab) {
        telegramTab.addEventListener('shown.bs.tab', function() {
            loadTelegramStatus();
        });
    }

    // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ Telegram —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if (document.getElementById('telegramTab')?.classList.contains('active')) {
        loadTelegramStatus();
    }
});
</script>
{% endblock %}