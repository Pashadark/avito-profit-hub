{% extends 'base.html' %}
{% load static %}
{% load notifications_tags %}

{% block content %}
    <style>
        .container-xxl.flex-grow-1.container-p-y {
            max-width: 1800px !important;
            margin: 0 auto !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        @media (max-width: 1800px) {
            .container-xxl.flex-grow-1.container-p-y {
                max-width: 100% !important;
            }
        }

        @media (max-width: 768px) {
            .container-xxl.flex-grow-1.container-p-y {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
        }

        /* üî• –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º */
        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
            padding: 0.625rem 1rem;
            font-size: 0.9375rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #666cff;
            box-shadow: 0 0 0 3px rgba(102, 108, 255, 0.1);
        }

        .form-label {
            font-weight: 600;
            color: #566a7f;
            margin-bottom: 0.5rem;
            font-size: 0.9375rem;
        }

        .form-text {
            font-size: 0.8125rem;
            color: #8592a3;
            margin-top: 0.375rem;
        }

        /* üî• –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –æ—Ç—Å—Ç—É–ø—ã */
        .card {
            border-radius: 0.75rem;
            border: 1px solid #e0e5ed;
            box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e5ed;
            padding: 1.25rem 1.5rem;
            border-radius: 0.75rem 0.75rem 0 0 !important;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* üî• –ö–Ω–æ–ø–∫–∏ */
        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            transition: all 0.2s ease;
            font-size: 0.9375rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* üî• –°–ø–∏—Å–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .list-group-item {
            border: none;
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .list-group-item:hover {
            background-color: #f8fafc;
        }

        /* üî• –ë—ç–π–¥–∂–∏ */
        .badge {
            border-radius: 0.375rem;
            font-weight: 500;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
        }

        /* üî• Switch */
        .form-check-input {
            width: 2.5rem;
            height: 1.25rem;
            margin-top: 0.1875rem;
        }

        .form-check-input:checked {
            background-color: #666cff;
            border-color: #666cff;
        }

        /* üî• –ê–ª–µ—Ä—Ç—ã */
        .alert {
            border-radius: 0.5rem;
            border: 1px solid transparent;
            padding: 1rem 1.25rem;
        }

        /* üî• –û—Ç—Å—Ç—É–ø—ã –∏ —Å–µ—Ç–∫–∞ */
        .row {
            margin-bottom: 1.5rem;
        }

        .row:last-child {
            margin-bottom: 0;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mt-4 {
            margin-top: 1.5rem !important;
        }

        .pt-4 {
            padding-top: 1.5rem !important;
        }

        /* üî• –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –≥–æ—Ä–æ–¥–æ–≤ */
        #citySuggestions {
            position: absolute;
            z-index: 1050;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            width: 100%;
        }

        #citySuggestions .list-group-item {
            padding: 0.75rem 1rem;
            border-radius: 0;
            cursor: pointer;
        }

        #citySuggestions .list-group-item:hover {
            background-color: #e7f1ff;
            color: #0d6efd;
        }

        /* üî• –°—Ç–∞—Ç—É—Å—ã */
        .status-running {
            color: #28a745;
            font-weight: 600;
        }

        .status-stopped {
            color: #dc3545;
            font-weight: 600;
        }

        .status-warning {
            color: #ffc107;
            font-weight: 600;
        }

        /* üî• Input group */
        .input-group .btn {
            border-radius: 0 0.5rem 0.5rem 0;
        }

        /* üî• –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* üî• –•–æ–≤–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .card:hover {
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* üî• –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã */
        ::placeholder {
            color: #9aa3b3 !important;
            opacity: 0.8;
        }

        /* üî• –ò–∫–æ–Ω–∫–∏ */
        .ri {
            font-size: 1.125em;
            vertical-align: middle;
        }

        /* üî• –¢–∞–π–º–µ—Ä */
        .blinking {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* üî• –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .card-title {
            color: #566a7f;
            font-weight: 600;
        }

        h5.card-title {
            font-size: 1.125rem;
        }

        h6.fw-semibold {
            color: #566a7f;
            font-size: 0.9375rem;
        }

        /* üî• –¢–µ–∫—Å—Ç */
        .text-muted {
            color: #8592a3 !important;
        }

        /* üî• –ë–ª–æ–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ */
        .bg-light {
            background-color: #f8fafc !important;
            border-radius: 0.5rem;
        }
    </style>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –æ—Å–Ω–æ–≤–Ω–∞—è -->
        <div class="col-lg-8">
            <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="ri-dashboard-line me-2"></i>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="parserStatusInfo">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center p-3 rounded bg-light">
                                <div class="flex-shrink-0">
                                    <i class="ri-cpu-line fs-3 text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">–°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–µ—Ä–∞</h6>
                                    <span class="h6 mb-0" id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center p-3 rounded bg-light">
                                <div class="flex-shrink-0">
                                    <i class="ri-window-line fs-3 text-info"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">–û–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞</h6>
                                    <span class="h6 mb-0" id="windowsText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center p-3 rounded bg-light">
                                <div class="flex-shrink-0">
                                    <i class="ri-timer-line fs-3 text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">–¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç—ã</h6>
                                    <span class="h6 mb-0" id="timerText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center p-3 rounded bg-light">
                                <div class="flex-shrink-0">
                                    <i class="ri-global-line fs-3 text-success"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">–°–∞–π—Ç</h6>
                                    <span class="h6 mb-0" id="siteText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-light border">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted d-block">–¶–∏–∫–ª–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                                        <strong id="cycleCount" class="fs-5">0</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ URL</small>
                                        <strong id="processedUrls" class="fs-5">0</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</small>
                                        <strong id="activeQueries" class="fs-5">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="ri-settings-3-line me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="parserSettingsForm">
                        {% csrf_token %}

                        <!-- –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ settings_id –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É -->
                        {% if form.instance.id %}
                        <input type="hidden" name="settings_id" value="{{ form.instance.id }}">
                        {% else %}
                        <input type="hidden" name="settings_id" value="">
                        {% endif %}

                        <!-- üî• –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–¢–ö–ê -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫</label>
                                {{ form.name }}
                                <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4 pt-3">
                                    {{ form.is_default }}
                                    <label class="form-check-label fw-semibold" for="{{ form.is_default.id_for_label }}">
                                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- üî• –ì–û–†–û–î –ò –°–ê–ô–¢ - –í–´–†–û–í–ù–ï–ù–ù–´–ï –ü–û–õ–Ø -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">–ì–æ—Ä–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞</label>
                                <div class="input-group">
                                    <input type="text"
                                           name="city"
                                           class="form-control"
                                           id="id_city"
                                           value="{{ form.city.value|default:'–ú–æ—Å–∫–≤–∞' }}"
                                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥..."
                                           autocomplete="off"
                                           oninput="searchCities(this.value)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="showCityList()">
                                        <i class="ri-map-pin-line"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º
                                </div>

                                <!-- üî• –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç) -->
                                <div class="list-group mt-1" id="citySuggestions" style="display: none;">
                                    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>

                                <!-- üî• –°–∫—Ä—ã—Ç—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ -->
                                <div class="mt-2" id="popularCities" style="display: none;">
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ú–æ—Å–∫–≤–∞')">–ú–æ—Å–∫–≤–∞</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')">–°–ü–±</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫')">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥')">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ö–∞–∑–∞–Ω—å')">–ö–∞–∑–∞–Ω—å</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥')">–ù–ù</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä')">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–°–æ—á–∏')">–°–æ—á–∏</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–ü–µ–Ω–∑–∞')">–ü–µ–Ω–∑–∞</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–í–æ—Ä–æ–Ω–µ–∂')">–í–æ—Ä–æ–Ω–µ–∂</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É')">–†–æ—Å—Ç–æ–≤</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCity('')">–í—Å—è –†–æ—Å—Å–∏—è</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–°–∞–π—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞</label>
                                <select class="form-select" id="site_select" name="site">
                                    <option value="avito" {% if current_site == 'avito' %}selected{% endif %}>Avito</option>
                                    <option value="auto.ru" {% if current_site == 'auto.ru' %}selected{% endif %}>Auto.ru</option>
                                </select>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–π—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞</div>

                                <!-- –ü–û–î–°–ö–ê–ó–ö–ò –î–õ–Ø AUTO.RU -->
                                <div class="alert alert-info py-2 mt-2" id="auto_ru_tips" style="display: none;">
                                    <small>
                                        <i class="ri-information-line me-1"></i>
                                        <strong>–î–ª—è Auto.ru —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã:</strong>
                                        "ford focus", "toyota camry", "bmw x5 2018", "volkswagen golf"
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- üî• –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê - –£–õ–£–ß–®–ï–ù–ù–´–ô –í–ù–ï–®–ù–ò–ô –í–ò–î -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</label>
                                {{ form.keywords }}
                                <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: iPhone, MacBook, –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞)</div>
                            </div>
                        </div>

                        <!-- üî• –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label">–ò—Å–∫–ª—é—á–∏—Ç—å —Å–ª–æ–≤–∞</label>
                                {{ form.exclude_keywords }}
                                <div class="form-text">–¢–æ–≤–∞—Ä—ã —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —ç—Ç–∏ —Å–ª–æ–≤–∞ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã</div>
                            </div>
                        </div>

                        <!-- üî• –§–ò–õ–¨–¢–†–´ –¶–ï–ù–´ - –í–´–†–û–í–ù–ï–ù–ù–´–ï –ü–û–õ–Ø -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">–¶–µ–Ω–∞ –æ—Ç (‚ÇΩ)</label>
                                {{ form.min_price }}
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ª—é–±–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–¶–µ–Ω–∞ –¥–æ (‚ÇΩ)</label>
                                {{ form.max_price }}
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ª—é–±–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</div>
                            </div>
                        </div>

                        <!-- üî• –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ò–õ–¨–¢–†–´ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–∞</label>
                                {{ form.min_rating }}
                                <div class="form-text">–æ—Ç 0 –¥–æ 5 –∑–≤–µ–∑–¥, –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ª—é–±–æ–≥–æ</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–¢–∏–ø –ø—Ä–æ–¥–∞–≤—Ü–∞</label>
                                {{ form.seller_type }}
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–¥–∞–≤—Ü–∞</div>
                            </div>
                        </div>

                        <!-- üî• –ù–ê–°–¢–†–û–ô–ö–ò –ü–ê–†–°–ï–†–ê - –í–´–†–û–í–ù–ï–ù–ù–´–ï –ü–û–õ–Ø -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                                {{ form.check_interval }}
                                <div class="form-text">–º–∏–Ω—É—Ç, –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–õ–∏–º–∏—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ —á–∞—Å</label>
                                {{ form.max_items_per_hour }}
                                <div class="form-text">–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–û–∫–æ–Ω –±—Ä–∞—É–∑–µ—Ä–∞</label>
                                {{ form.browser_windows }}
                                <div class="form-text">–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                            </div>
                        </div>

                        <!-- üî• –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–£–°–ö–ê - –°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê -->
                        <div class="card border-warning mb-4">
                            <div class="card-header bg-warning bg-opacity-10 border-warning">
                                <h6 class="card-title mb-0 text-warning"><i class="ri-play-circle-line me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç—ã</label>
                                        <select class="form-select" id="timer_hours" name="timer_hours">
                                            <option value="">–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ</option>
                                            <option value="1">1 —á–∞—Å</option>
                                            <option value="2" selected>2 —á–∞—Å–∞</option>
                                            <option value="4">4 —á–∞—Å–∞</option>
                                            <option value="6">6 —á–∞—Å–æ–≤</option>
                                            <option value="8">8 —á–∞—Å–æ–≤</option>
                                            <option value="12">12 —á–∞—Å–æ–≤</option>
                                        </select>
                                        <div class="form-text">–ü–∞—Ä—Å–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω</label>
                                        <select class="form-select" id="launch_browser_windows" name="launch_browser_windows">
                                            <option value="1">1 –æ–∫–Ω–æ</option>
                                            <option value="2">2 –æ–∫–Ω–∞</option>
                                            <option value="3" selected>3 –æ–∫–Ω–∞</option>
                                            <option value="4">4 –æ–∫–Ω–∞</option>
                                            <option value="5">5 –æ–∫–æ–Ω</option>
                                        </select>
                                        <div class="form-text">–ë–æ–ª—å—à–µ –æ–∫–æ–Ω = –±—ã—Å—Ç—Ä–µ–µ –ø–æ–∏—Å–∫</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- üî• –ê–í–¢–û–ü–û–ò–°–ö -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                {{ form.is_active }}
                                <label class="form-check-label fw-semibold" for="{{ form.is_active.id_for_label }}">
                                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω
                                </label>
                            </div>
                            <div class="form-text">–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –ø–∞—Ä—Å–µ—Ä –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</div>
                        </div>

                        <!-- üî• –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø - –í–´–†–û–í–ù–ï–ù–ù–´–ï –ò –°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–´–ï -->
                        <div class="d-flex gap-3 flex-wrap border-top pt-4">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="submit" name="save_settings" class="btn btn-primary" onclick="saveSettings(event)">
                                    <i class="ri-save-line me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                </button>

                                <button type="button" class="btn btn-outline-secondary" onclick="createNewSettings()">
                                    <i class="ri-add-line me-1"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ
                                </button>

                                <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø -->
                                {% if form.instance.id and not form.instance.is_default %}
                                <button type="button" class="btn btn-outline-danger" onclick="deleteSettings({{ form.instance.id }})">
                                    <i class="ri-delete-bin-line me-1"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2 flex-wrap ms-auto">
                                <button type="button" id="toggleParserBtn"
                                        class="btn {% if parser_status == '—Ä–∞–±–æ—Ç–∞–µ—Ç' %}btn-danger{% else %}btn-success{% endif %}">
                                    {% if parser_status == '—Ä–∞–±–æ—Ç–∞–µ—Ç' %}
                                        <i class="ri-stop-circle-line me-1"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä
                                    {% else %}
                                        <i class="ri-play-circle-line me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä
                                    {% endif %}
                                </button>

                                <button type="button" class="btn btn-warning" onclick="launchParserWithSettings()">
                                    <i class="ri-rocket-2-line me-1"></i> –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- üî• –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ò–°–¢–û–†–ò–Ø –ò –°–ü–ò–°–ö–ò -->
        <div class="col-lg-4">
            <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="ri-list-check me-2"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                    <small class="text-muted">–¢–æ–ª—å–∫–æ –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small>
                </div>
                <div class="card-body p-0">
                    {% if all_settings %}
                    <div class="list-group list-group-flush">
                        {% for settings in all_settings %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <h6 class="mb-0 {% if settings.is_default %}text-success{% endif %}">
                                            {{ settings.name }}
                                        </h6>
                                        {% if settings.is_default %}
                                        <span class="badge bg-success ms-2">–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted d-block mb-1">
                                        {{ settings.keywords|truncatewords:4 }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="ri-time-line me-1"></i>{{ settings.updated_at|date:"d.m.Y H:i" }}
                                    </small>
                                    {% if settings.exclude_keywords %}
                                    <div class="mt-1">
                                        <small class="text-danger">
                                            <i class="ri-forbid-line me-1"></i>–ò—Å–∫–ª—é—á–∏—Ç—å: {{ settings.exclude_keywords|truncatewords:2 }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="btn-group ms-2 flex-shrink-0">
                                    <button type="button" onclick="loadSettings({{ settings.id }})"
                                            class="btn btn-sm btn-outline-primary" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
                                        <i class="ri-edit-line"></i>
                                    </button>
                                    <button type="button" onclick="runWithSettings({{ settings.id }})"
                                            class="btn btn-sm btn-outline-success" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å —ç—Ç–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏">
                                        <i class="ri-play-line"></i>
                                    </button>
                                    <!-- –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –í –°–ü–ò–°–ö–ï -->
                                    {% if not settings.is_default %}
                                    <button type="button" onclick="deleteSettings({{ settings.id }})"
                                            class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ri-list-check display-4 text-muted mb-3"></i>
                        <p class="text-muted mb-0">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="ri-information-line me-2"></i>–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="fw-semibold mb-2">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</h6>
                        <div>
                            {% for keyword in current_keywords %}
                                <span class="badge bg-primary me-1 mb-1">{{ keyword }}</span>
                            {% empty %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                            {% endfor %}
                        </div>
                    </div>

                    {% if form.instance.exclude_keywords %}
                    <div class="mb-3">
                        <h6 class="fw-semibold mb-2">–ò—Å–∫–ª—é—á–∏—Ç—å —Å–ª–æ–≤–∞:</h6>
                        <div>
                            {% for keyword in form.instance.exclude_keywords_list %}
                                <span class="badge bg-danger me-1 mb-1">{{ keyword }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <h6 class="fw-semibold mb-3">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:</h6>
                    <div class="row g-2 small">
                        <div class="col-6">
                            <span class="text-muted">–¶–µ–Ω–∞:</span>
                            <div class="fw-semibold">
                                {% if form.instance.min_price or form.instance.max_price %}
                                    {{ form.instance.min_price|default:"–ª—é–±–∞—è" }} - {{ form.instance.max_price|default:"–ª—é–±–∞—è" }} ‚ÇΩ
                                {% else %}
                                    –ª—é–±–∞—è
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">–†–µ–π—Ç–∏–Ω–≥:</span>
                            <div class="fw-semibold">
                                {% if form.instance.min_rating %}
                                    –æ—Ç {{ form.instance.min_rating }}/5
                                {% else %}
                                    –ª—é–±–æ–π
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">–ü—Ä–æ–¥–∞–≤–µ—Ü:</span>
                            <div class="fw-semibold">
                                {% if form.instance.seller_type %}
                                    {{ form.instance.get_seller_type_display }}
                                {% else %}
                                    –ª—é–±–æ–π
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">–ò–Ω—Ç–µ—Ä–≤–∞–ª:</span>
                            <div class="fw-semibold">
                                {% if form.instance.check_interval %}
                                    {{ form.instance.check_interval }} –º–∏–Ω
                                {% else %}
                                    –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">–õ–∏–º–∏—Ç/—á–∞—Å:</span>
                            <div class="fw-semibold">
                                {% if form.instance.max_items_per_hour %}
                                    {{ form.instance.max_items_per_hour }}
                                {% else %}
                                    –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <span class="text-muted">–û–∫–Ω–∞:</span>
                            <div class="fw-semibold">
                                {% if form.instance.browser_windows %}
                                    {{ form.instance.browser_windows }}
                                {% else %}
                                    –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—Ö–æ–¥–∫–∏ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="ri-history-line me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—Ö–æ–¥–∫–∏</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_activities %}
                        <div class="list-group list-group-flush">
                            {% for activity in recent_activities|slice:":5" %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="fw-medium small mb-1">{{ activity.title|truncatewords:5 }}</div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-success fw-semibold">{{ activity.price }}‚ÇΩ</span>
                                            <small class="text-muted">{{ activity.found_at|date:"H:i" }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ri-shopping-bag-line display-4 text-muted mb-3"></i>
                        <p class="text-muted mb-3">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –Ω–∞—Ö–æ–¥–∫–∏</p>
                    </div>
                    {% endif %}

                    <div class="p-3 border-top">
                        <a href="{% url 'website:found_items' %}" class="btn btn-outline-primary w-100">
                            <i class="ri-shopping-bag-line me-1"></i> –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
let statusUpdateInterval = null;

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –°–ò–°–¢–ï–ú–£
function showAlert(message, type = 'info') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    switch(type.toLowerCase()) {
        case 'success':
            if (typeof notificationSuccess === 'function') {
                notificationSuccess(message, '–£—Å–ø–µ—Ö');
            } else if (typeof toastr !== 'undefined') {
                toastr.success(message, '–£—Å–ø–µ—Ö');
            }
            break;

        case 'error':
        case 'danger':
            if (typeof notificationError === 'function') {
                notificationError(message, '–û—à–∏–±–∫–∞');
            } else if (typeof toastr !== 'undefined') {
                toastr.error(message, '–û—à–∏–±–∫–∞');
            }
            break;

        case 'warning':
            if (typeof notificationWarning === 'function') {
                notificationWarning(message, '–í–Ω–∏–º–∞–Ω–∏–µ');
            } else if (typeof toastr !== 'undefined') {
                toastr.warning(message, '–í–Ω–∏–º–∞–Ω–∏–µ');
            }
            break;

        case 'info':
        default:
            if (typeof notificationInfo === 'function') {
                notificationInfo(message, '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
            } else if (typeof toastr !== 'undefined') {
                toastr.info(message, '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
            }
            break;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
function updateStatusDisplay(status) {
    console.log('üé® –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', status);

    // –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–µ—Ä–∞
    const statusElement = document.getElementById('statusText');
    if (statusElement) {
        statusElement.innerHTML = status.is_running ?
            '<span class="status-running">–†–∞–±–æ—Ç–∞–µ—Ç</span>' :
            '<span class="status-stopped">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
    }

    // –û–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞
    const windowsElement = document.getElementById('windowsText');
    if (windowsElement) {
        const driversText = status.drivers_count > 0 ? ` (–∑–∞–ø—É—â–µ–Ω–æ: ${status.drivers_count})` : '';
        windowsElement.innerHTML =
            `<span class="status-running">${status.browser_windows || 0} –æ–∫–æ–Ω${driversText}</span>`;
    }

    // –¢–∞–π–º–µ—Ä
    const timerElement = document.getElementById('timerText');
    if (timerElement) {
        if (status.timer_active && status.timer_remaining && status.timer_remaining !== '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω') {
            timerElement.innerHTML = `<span class="status-running">‚è∞ ${status.timer_remaining}</span>`;
        } else {
            timerElement.innerHTML = '<span class="status-warning">‚è∞ –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
        }
    }

    // –°–∞–π—Ç
    const siteElement = document.getElementById('siteText');
    if (siteElement) {
        const siteNames = {
            'avito': 'Avito',
            'auto.ru': 'Auto.ru'
        };
        const siteDisplay = siteNames[status.current_site] || status.current_site || 'Avito';
        siteElement.innerHTML = `<span class="status-running">${siteDisplay}</span>`;
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    const cycleCountElement = document.getElementById('cycleCount');
    if (cycleCountElement) {
        cycleCountElement.textContent = '0';
    }

    const processedUrlsElement = document.getElementById('processedUrls');
    if (processedUrlsElement) {
        processedUrlsElement.textContent = '0';
    }

    const activeQueriesElement = document.getElementById('activeQueries');
    if (activeQueriesElement) {
        activeQueriesElement.textContent = status.search_queries_count || 0;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    updateParserButton(status.is_running);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
function updateParserButton(isRunning) {
    const button = document.getElementById('toggleParserBtn');
    if (!button) return;

    if (isRunning) {
        button.innerHTML = '<i class="ri-stop-circle-line me-1"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä';
        button.classList.remove('btn-success');
        button.classList.add('btn-danger');
    } else {
        button.innerHTML = '<i class="ri-play-circle-line me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä';
        button.classList.remove('btn-danger');
        button.classList.add('btn-success');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–µ—Ä–∞
function refreshParserStatus() {
    console.log('üîÑ –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–µ—Ä–∞...');

    const parserStatusUrl = '/api/parser-status/';

    fetch(parserStatusUrl)
    .then(response => {
        console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä –î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—É—á–µ–Ω—ã:', data);

        if (data.status === 'success') {
            updateStatusDisplay(data.parser_status);
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞:', data);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (data.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            showDiagnosticsButton();
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);

        // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
        if (error.message.includes('404')) {
            errorMessage = '–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (404)';
        } else if (error.message.includes('500')) {
            errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (500)';
        } else if (error.message.includes('NetworkError')) {
            errorMessage = '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é';
        }

        const statusElement = document.getElementById('statusText');
        if (statusElement) {
            statusElement.innerHTML = `<span class="status-stopped">‚ùå ${errorMessage}</span>`;
        }
        showAlert(errorMessage, 'error');
        showDiagnosticsButton();
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
function showDiagnosticsButton() {
    const diagnosticsBtn = document.getElementById('diagnosticsBtn');
    if (!diagnosticsBtn) {
        const buttonContainer = document.querySelector('.d-flex.gap-2.flex-wrap');
        if (buttonContainer) {
            buttonContainer.innerHTML += `
                <button type="button" class="btn btn-outline-warning" onclick="runDiagnostics()">
                    <i class="ri-bug-line me-1"></i> –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                </button>
            `;
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
function runDiagnostics() {
    showAlert('–ó–∞–ø—É—Å–∫–∞—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');

    fetch('/parser-diagnostics/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:', data.diagnostics);
            showAlert('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.', 'success');

            const diagnostics = data.diagnostics;
            let message = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:\n';
            message += `‚Ä¢ –ü–∞—Ä—Å–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω: ${diagnostics.parser_instance_exists ? '‚úÖ' : '‚ùå'}\n`;
            message += `‚Ä¢ –ó–∞–ø—É—â–µ–Ω: ${diagnostics.is_running ? '‚úÖ' : '‚ùå'}\n`;
            message += `‚Ä¢ –û–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞: ${diagnostics.browser_windows || 0}\n`;
            message += `‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä –±—Ä–∞—É–∑–µ—Ä–∞: ${diagnostics.browser_manager_exists ? '‚úÖ' : '‚ùå'}\n`;

            alert(message);
        } else {
            showAlert('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + error, 'error');
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
function toggleParser() {
    const button = document.getElementById('toggleParserBtn');
    const originalText = button.innerHTML;
    const isRunning = button.classList.contains('btn-danger');

    button.disabled = true;
    button.innerHTML = '<i class="ri-loader-4-line me-1"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞...';

    showAlert(isRunning ? '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø–∞—Ä—Å–µ—Ä...' : '–ó–∞–ø—É—Å–∫–∞—é –ø–∞—Ä—Å–µ—Ä...', 'info');

    fetch('/toggle-parser/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            refreshParserStatus();
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        button.innerHTML = originalText;
    })
    .finally(() => {
        setTimeout(() => {
            button.disabled = false;
        }, 2000);
    });
}

// üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê –ü–ê–†–°–ï–†–ê –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò
function launchParserWithSettings() {
    const timerHours = document.getElementById('timer_hours').value;
    const browserWindows = document.getElementById('launch_browser_windows').value;
    const site = document.getElementById('site_select').value;
    const city = document.getElementById('id_city').value; // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ì–û–†–û–î

    console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', {
        timerHours, browserWindows, site, city // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –õ–û–ì
    });

    if (!timerHours) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Ç–∞–π–º–µ—Ä–∞', 'warning');
        return;
    }

    showAlert(`–ó–∞–ø—É—Å–∫–∞—é –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Å–∞–π—Ç–∞ ${site === 'auto.ru' ? 'Auto.ru' : 'Avito'} –≤ –≥–æ—Ä–æ–¥–µ ${city || '–ú–æ—Å–∫–≤–∞'}...`, 'info');

    fetch('/launch-parser-with-params/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            timer_hours: timerHours,
            browser_windows: parseInt(browserWindows),
            site: site,
            city: city || '–ú–æ—Å–∫–≤–∞' // üî• –ü–ï–†–ï–î–ê–ï–ú –ì–û–†–û–î
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            setTimeout(refreshParserStatus, 2000);
        } else if (data.status === 'warning') {
            showAlert(data.message, 'warning');
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

// –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
function runWithSettings(settingsId) {
    const site = document.getElementById('site_select').value;

    showAlert(`–ó–∞–ø—É—Å–∫–∞—é –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Å–∞–π—Ç–∞ ${site} —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏...`, 'Success');

    const formData = new FormData();
    formData.append('settings_id', settingsId);
    formData.append('site', site);
    formData.append('csrfmiddlewaretoken', getCSRFToken());

    fetch('/start-parser-with-settings/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            setTimeout(refreshParserStatus, 2000);
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function loadSettings(settingsId) {
    showAlert('–ó–∞–≥—Ä—É–∂–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');

    const formData = new FormData();
    formData.append('load_settings', settingsId);
    formData.append('csrfmiddlewaretoken', getCSRFToken());

    fetch('/parser-settings/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function deleteSettings(settingsId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?')) {
        return;
    }

    showAlert('–£–¥–∞–ª—è—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');

    const formData = new FormData();
    formData.append('delete_settings', settingsId);
    formData.append('csrfmiddlewaretoken', getCSRFToken());

    fetch('/parser-settings/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å AJAX
function saveSettings(event) {
    event.preventDefault();

    const form = document.getElementById('parserSettingsForm');
    const formData = new FormData(form);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
    const minPrice = formData.get('min_price');
    const maxPrice = formData.get('max_price');
    const minRating = formData.get('min_rating');
    const checkInterval = formData.get('check_interval');
    const browserWindows = formData.get('browser_windows');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞)
    if (minPrice && parseFloat(minPrice) < 0) {
        showAlert('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞)
    if (maxPrice && parseFloat(maxPrice) < 0) {
        showAlert('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω)
    if (minRating && (parseFloat(minRating) < 0 || parseFloat(minRating) > 5)) {
        showAlert('–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 5', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω)
    if (checkInterval && (parseInt(checkInterval) < 5 || parseInt(checkInterval) > 1440)) {
        showAlert('–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 5 –¥–æ 1440 –º–∏–Ω—É—Ç', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω –±—Ä–∞—É–∑–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
    if (browserWindows && (parseInt(browserWindows) < 1 || parseInt(browserWindows) > 5)) {
        showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 5', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
    if (minPrice && maxPrice && parseFloat(minPrice) >= parseFloat(maxPrice)) {
        showAlert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π', 'error');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    const name = formData.get('name');
    const keywords = formData.get('keywords');

    if (!name || !name.trim()) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        return;
    }

    if (!keywords || !keywords.trim()) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
        return;
    }

    showAlert('–°–æ—Ö—Ä–∞–Ω—è—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');

    fetch('/ajax-save-settings/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');

            // –û–±–Ω–æ–≤–ª—è–µ–º ID –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —Ñ–æ—Ä–º–µ
            if (data.settings_id) {
                const settingsIdInput = document.querySelector('input[name="settings_id"]');
                if (settingsIdInput) {
                    settingsIdInput.value = data.settings_id;
                }
            }

            setTimeout(() => {
                window.location.reload();
            }, 1500);

        } else {
            // –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            if (data.error_messages && data.error_messages.length > 0) {
                const errorText = data.error_messages.join('\n');
                showAlert('–û—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ:\n' + errorText, 'error');
            } else if (data.errors) {
                let errorMessages = [];
                for (let field in data.errors) {
                    const fieldErrors = data.errors[field];
                    fieldErrors.forEach(error => {
                        errorMessages.push(error.message);
                    });
                }
                showAlert('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ' + errorMessages.join(', '), 'error');
            } else {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
function createNewSettings() {
    if (confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –¢–µ–∫—É—â–∏–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        const settingsIdInput = document.querySelector('input[name="settings_id"]');
        if (settingsIdInput) {
            settingsIdInput.value = '';
        }

        // –û—á–∏—â–∞–µ–º –í–°–ï –ø–æ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
        const nameInput = document.querySelector('input[name="name"]');
        const keywordsInput = document.querySelector('textarea[name="keywords"]');
        const excludeInput = document.querySelector('textarea[name="exclude_keywords"]');

        if (nameInput) nameInput.value = '–ú–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ' + new Date().toLocaleDateString();
        if (keywordsInput) keywordsInput.value = '';
        if (excludeInput) excludeInput.value = '';

        // –û—á–∏—â–∞–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        const fieldsToClear = [
            'min_price', 'max_price', 'min_rating',
            'check_interval', 'max_items_per_hour', 'browser_windows'
        ];

        fieldsToClear.forEach(fieldName => {
            const input = document.querySelector(`[name="${fieldName}"]`);
            if (input) input.value = '';
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –∫ –ø—É—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
        const sellerTypeSelect = document.querySelector('select[name="seller_type"]');
        if (sellerTypeSelect) sellerTypeSelect.value = '';

        // –°–Ω–∏–º–∞–µ–º –í–°–ï –≥–∞–ª–æ—á–∫–∏
        const isDefaultCheckbox = document.querySelector('input[name="is_default"]');
        if (isDefaultCheckbox) isDefaultCheckbox.checked = false;

        const isActiveCheckbox = document.querySelector('input[name="is_active"]');
        if (isActiveCheckbox) isActiveCheckbox.checked = false;

        showAlert('–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –Ω—É–ª—è. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è!', 'info');
    }
}

// üî• –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø CSRF –¢–û–ö–ï–ù–ê
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// üî• –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´
function runSystemDiagnostics() {
    console.log('üîß –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');

    showAlert('–ó–∞–ø—É—Å–∫–∞—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã...', 'info');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
    fetch('/api/parser-status/')
        .then(response => {
            console.log('üì° API —Å—Ç–∞—Ç—É—Å:', response.status);
            if (response.ok) {
                showAlert('API –¥–æ—Å—Ç—É–ø–µ–Ω ‚úÖ', 'success');
            } else {
                showAlert(`API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status} ‚ùå`, 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
            showAlert('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚ùå', 'error');
        });
}

// üî• –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò –í –ò–ù–¢–ï–†–§–ï–ô–°
function addDiagnosticsButton() {
    const buttonContainer = document.querySelector('.d-flex.gap-2.flex-wrap');
    if (buttonContainer && !document.getElementById('diagnosticsBtn')) {
        buttonContainer.innerHTML += `
            <button type="button" id="diagnosticsBtn" class="btn btn-outline-info" onclick="runSystemDiagnostics()">
                <i class="ri-bug-line me-1"></i> –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            </button>
        `;
    }
}

// =============== –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ –ì–û–†–û–î–û–í ===============

let allCities = [];
let citySearchTimeout = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
function loadCities() {
    console.log('üèôÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...');

    fetch('/api/get-cities/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                allCities = data.cities.sort((a, b) => a.localeCompare(b));
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allCities.length} –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ ${data.source}`);
                console.log('–ü–µ—Ä–≤—ã–µ 10 –≥–æ—Ä–æ–¥–æ–≤:', allCities.slice(0, 10));
            } else {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', data.message);
                loadFallbackCities();
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ —á–µ—Ä–µ–∑ API:', error);
            loadFallbackCities();
        });
}

// –ó–∞–ø–∞—Å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function loadFallbackCities() {
    allCities = [
        '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
        '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
        '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–í–æ—Ä–æ–Ω–µ–∂', '–ü–µ—Ä–º—å', '–í–æ–ª–≥–æ–≥—Ä–∞–¥', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',
        '–°–æ—á–∏', '–ü–µ–Ω–∑–∞', '–¢—é–º–µ–Ω—å', '–ò–∂–µ–≤—Å–∫', '–ò—Ä–∫—É—Ç—Å–∫', '–£–ª—å—è–Ω–æ–≤—Å–∫',
        '–•–∞–±–∞—Ä–æ–≤—Å–∫', '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', '–Ø—Ä–æ—Å–ª–∞–≤–ª—å', '–ú–∞—Ö–∞—á–∫–∞–ª–∞', '–¢–æ–º—Å–∫',
        '–û—Ä–µ–Ω–±—É—Ä–≥', '–ö–µ–º–µ—Ä–æ–≤–æ', '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å', '–†—è–∑–∞–Ω—å', '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',
        '–õ–∏–ø–µ—Ü–∫', '–¢—É–ª–∞', '–ö–∏—Ä–æ–≤', '–ß–µ–±–æ–∫—Å–∞—Ä—ã', '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–ö—É—Ä—Å–∫',
        '–£–ª–∞–Ω-–£–¥—ç', '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å', '–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫', '–¢–≤–µ—Ä—å', '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å',
        '–°—É—Ä–≥—É—Ç', '–ë—Ä—è–Ω—Å–∫', '–ò–≤–∞–Ω–æ–≤–æ', '–ë–µ–ª–≥–æ—Ä–æ–¥', '–°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å',
        '–ê–Ω–∞–ø–∞', '–ê—Ä–º–∞–≤–∏—Ä', '–ì–µ–ª–µ–Ω–¥–∂–∏–∫', '–ï–π—Å–∫', '–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫', '–¢—É–∞–ø—Å–µ',
        '–ê–ø—à–µ—Ä–æ–Ω—Å–∫', '–ë–µ–ª–æ—Ä–µ—á–µ–Ω—Å–∫', '–ì–æ—Ä—è—á–∏–π –ö–ª—é—á', '–ö—Ä–æ–ø–æ—Ç–∫–∏–Ω', '–ö—Ä—ã–º—Å–∫',
        '–õ–∞–±–∏–Ω—Å–∫', '–°–ª–∞–≤—è–Ω—Å–∫-–Ω–∞-–ö—É–±–∞–Ω–∏', '–¢–∏–º–∞—à—ë–≤—Å–∫', '–¢–∏—Ö–æ—Ä–µ—Ü–∫', '–ê–±–∏–Ω—Å–∫'
    ].sort((a, b) => a.localeCompare(b));

    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allCities.length} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤`);
}

// üî• –ü–û–ò–°–ö –ì–û–†–û–î–û–í –ü–†–ò –í–í–û–î–ï
function searchCities(searchText) {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
    if (citySearchTimeout) {
        clearTimeout(citySearchTimeout);
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞
    citySearchTimeout = setTimeout(() => {
        performCitySearch(searchText);
    }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
}

// üî• –í–´–ü–û–õ–ù–ï–ù–ò–ï –ü–û–ò–°–ö–ê
function performCitySearch(searchText) {
    const suggestionsContainer = document.getElementById('citySuggestions');
    if (!suggestionsContainer) return;

    if (!searchText || searchText.trim().length < 1) {
        // –ï—Å–ª–∏ –≤–≤–æ–¥ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
        showPopularCities();
        return;
    }

    const searchLower = searchText.toLowerCase().trim();

    // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    const matches = allCities.filter(city =>
        city.toLowerCase().includes(searchLower)
    ).slice(0, 15); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 15 –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.style.display = 'none';

    if (matches.length > 0) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('div');
        header.className = 'list-group-item bg-light fw-bold py-2';
        header.textContent = `–ù–∞–π–¥–µ–Ω–æ ${matches.length} –≥–æ—Ä–æ–¥–æ–≤:`;
        suggestionsContainer.appendChild(header);

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        matches.forEach(city => {
            const suggestion = document.createElement('button');
            suggestion.type = 'button';
            suggestion.className = 'list-group-item list-group-item-action text-start';

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            const highlightedCity = highlightMatch(city, searchText);
            suggestion.innerHTML = `<i class="ri-map-pin-line me-2 text-primary"></i> ${highlightedCity}`;

            suggestion.onclick = () => {
                setCity(city);
                hideCitySuggestions();
            };

            suggestion.onmouseenter = () => {
                suggestion.classList.add('active');
            };

            suggestion.onmouseleave = () => {
                suggestion.classList.remove('active');
            };

            suggestionsContainer.appendChild(suggestion);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        suggestionsContainer.style.display = 'block';

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        const cityInput = document.getElementById('id_city');
        if (cityInput) {
            suggestionsContainer.style.width = cityInput.offsetWidth + 'px';
            suggestionsContainer.style.top = (cityInput.offsetTop + cityInput.offsetHeight) + 'px';
            suggestionsContainer.style.left = cityInput.offsetLeft + 'px';
        }
    } else {
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        const noResults = document.createElement('div');
        noResults.className = 'list-group-item text-muted text-center py-3';
        noResults.innerHTML = '<i class="ri-search-line me-2"></i>–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω';
        suggestionsContainer.appendChild(noResults);
        suggestionsContainer.style.display = 'block';
    }
}

// üî• –ü–û–ö–ê–ó–ê–¢–¨ –ü–û–ü–£–õ–Ø–†–ù–´–ï –ì–û–†–û–î–ê
function showPopularCities() {
    const suggestionsContainer = document.getElementById('citySuggestions');
    if (!suggestionsContainer) return;

    const popularCities = [
        '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
        '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–°–æ—á–∏', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–í–æ—Ä–æ–Ω–µ–∂',
        '–°–∞–º–∞—Ä–∞', '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–ü–µ—Ä–º—å', '–¢—é–º–µ–Ω—å'
    ];

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.style.display = 'none';

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const header = document.createElement('div');
    header.className = 'list-group-item bg-light fw-bold py-2';
    header.textContent = '–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≥–æ—Ä–æ–¥–∞:';
    suggestionsContainer.appendChild(header);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
    popularCities.forEach(city => {
        const suggestion = document.createElement('button');
        suggestion.type = 'button';
        suggestion.className = 'list-group-item list-group-item-action text-start';
        suggestion.innerHTML = `<i class="ri-star-line me-2 text-warning"></i> ${city}`;

        suggestion.onclick = () => {
            setCity(city);
            hideCitySuggestions();
        };

        suggestionsContainer.appendChild(suggestion);
    });

    // –ö–Ω–æ–ø–∫–∞ "–≤—Å—è –†–æ—Å—Å–∏—è"
    const allRussiaBtn = document.createElement('button');
    allRussiaBtn.type = 'button';
    allRussiaBtn.className = 'list-group-item list-group-item-action text-center text-primary';
    allRussiaBtn.innerHTML = '<i class="ri-global-line me-2"></i> –í—Å—è –†–æ—Å—Å–∏—è';
    allRussiaBtn.onclick = () => {
        setCity('');
        hideCitySuggestions();
    };
    suggestionsContainer.appendChild(allRussiaBtn);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    suggestionsContainer.style.display = 'block';
}

// üî• –ü–û–î–°–í–ï–¢–ö–ê –°–û–í–ü–ê–î–ï–ù–ò–ô –í –†–ï–ó–£–õ–¨–¢–ê–¢–ê–• –ü–û–ò–°–ö–ê
function highlightMatch(text, search) {
    if (!search || search.trim() === '') return text;

    const searchLower = search.toLowerCase();
    const textLower = text.toLowerCase();
    const startIndex = textLower.indexOf(searchLower);

    if (startIndex >= 0) {
        const before = text.substring(0, startIndex);
        const match = text.substring(startIndex, startIndex + search.length);
        const after = text.substring(startIndex + search.length);

        return `${before}<span class="bg-warning text-dark">${match}</span>${after}`;
    }

    return text;
}

// üî• –£–°–¢–ê–ù–û–í–ò–¢–¨ –ì–û–†–û–î
function setCity(cityName) {
    const cityInput = document.getElementById('id_city');
    const siteSelect = document.getElementById('site_select');

    if (cityInput) {
        cityInput.value = cityName;

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω Auto.ru –∏ –≤–≤–µ–¥–µ–Ω –≥–æ—Ä–æ–¥ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        if (siteSelect && siteSelect.value === 'auto.ru' && cityName.trim() !== '') {
            showAlert('–î–ª—è Auto.ru –≥–æ—Ä–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏', 'warning');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        validateCityField();

        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏
        hideCitySuggestions();
        const popularCities = document.getElementById('popularCities');
        if (popularCities) {
            popularCities.style.display = 'none';
        }
    }
}

// üî• –°–ö–†–´–¢–¨ –ü–û–î–°–ö–ê–ó–ö–ò
function hideCitySuggestions() {
    const suggestionsContainer = document.getElementById('citySuggestions');
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
}

// üî• –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–û–õ–Ø –ì–û–†–û–î–ê
function validateCityField() {
    const cityInput = document.getElementById('id_city');
    const siteSelect = document.getElementById('site_select');
    const cityValue = cityInput ? cityInput.value.trim() : '';

    if (cityInput) {
        // –î–ª—è Auto.ru –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        if (siteSelect && siteSelect.value === 'auto.ru') {
            if (cityValue !== '') {
                cityInput.classList.add('is-invalid');
                cityInput.classList.remove('is-valid');
                cityInput.title = '–î–ª—è Auto.ru –≥–æ—Ä–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                return false;
            }
        }

        // –î–ª—è Avito - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≥–æ—Ä–æ–¥–∞
        if (siteSelect && siteSelect.value === 'avito') {
            if (cityValue === '' || cityValue === '–í—Å—è –†–æ—Å—Å–∏—è') {
                cityInput.classList.remove('is-invalid', 'is-valid');
                return true;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≥–æ—Ä–æ–¥ –≤ —Å–ø–∏—Å–∫–µ
            const isValid = allCities.some(city =>
                city.toLowerCase() === cityValue.toLowerCase()
            );

            if (isValid) {
                cityInput.classList.add('is-valid');
                cityInput.classList.remove('is-invalid');
            } else {
                cityInput.classList.add('is-invalid');
                cityInput.classList.remove('is-valid');
                cityInput.title = '–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç.';
                return false;
            }
        }
    }

    return true;
}

// üî• –ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ì–û–†–û–î–ê
function showCityList() {
    const popularCities = document.getElementById('popularCities');
    if (popularCities) {
        if (popularCities.style.display === 'none' || !popularCities.style.display) {
            popularCities.style.display = 'block';
            hideCitySuggestions();
        } else {
            popularCities.style.display = 'none';
        }
    }
}

// üî• –û–ë–†–ê–ë–û–¢–ß–ò–ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–ê–ô–¢–ê
function handleSiteChange() {
    const siteSelect = document.getElementById('site_select');
    const cityInput = document.getElementById('id_city');
    const cityFieldWrapper = document.querySelector('.city-field');

    if (!siteSelect || !cityInput) return;

    if (siteSelect.value === 'auto.ru') {
        // –î–ª—è Auto.ru –æ—Ç–∫–ª—é—á–∞–µ–º –≥–æ—Ä–æ–¥
        cityInput.disabled = true;
        cityInput.placeholder = '–î–ª—è Auto.ru –≥–æ—Ä–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
        cityInput.value = '';
        cityInput.title = '–î–ª—è Auto.ru –ø–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏';

        if (cityFieldWrapper) {
            cityFieldWrapper.style.opacity = '0.6';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        const tip = document.getElementById('auto_ru_tips');
        if (tip) {
            tip.style.display = 'block';
        }

        hideCitySuggestions();

    } else if (siteSelect.value === 'avito') {
        // –î–ª—è Avito –≤–∫–ª—é—á–∞–µ–º –≥–æ—Ä–æ–¥
        cityInput.disabled = false;
        cityInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥...';
        cityInput.value = cityInput.value || '–ú–æ—Å–∫–≤–∞';
        cityInput.title = '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ Avito';

        if (cityFieldWrapper) {
            cityFieldWrapper.style.opacity = '1';
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É Auto.ru
        const tip = document.getElementById('auto_ru_tips');
        if (tip) {
            tip.style.display = 'none';
        }

        validateCityField();
    }
}

// üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢–ê –ì–û–†–û–î–û–í
function initializeCityAutocomplete() {
    console.log('üåç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≥–æ—Ä–æ–¥–æ–≤...');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞
    loadCities();

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∞–π—Ç–∞
    const siteSelect = document.getElementById('site_select');
    if (siteSelect) {
        siteSelect.addEventListener('change', handleSiteChange);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => {
            handleSiteChange();
        }, 100);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–ª–µ –≥–æ—Ä–æ–¥–∞
    const cityInput = document.getElementById('id_city');
    if (cityInput) {
        cityInput.addEventListener('focus', function() {
            const siteSelect = document.getElementById('site_select');
            if (siteSelect && siteSelect.value === 'avito') {
                if (!this.value || this.value.trim() === '') {
                    showPopularCities();
                }
            }
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        cityInput.addEventListener('blur', function() {
            setTimeout(() => {
                validateCityField();
            }, 200);
        });
    }

    // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
    document.addEventListener('click', function(event) {
        const cityInput = document.getElementById('id_city');
        const suggestionsContainer = document.getElementById('citySuggestions');
        const popularCities = document.getElementById('popularCities');

        if (cityInput && !cityInput.contains(event.target) &&
            suggestionsContainer && !suggestionsContainer.contains(event.target) &&
            popularCities && !popularCities.contains(event.target)) {
            hideCitySuggestions();
            if (popularCities) {
                popularCities.style.display = 'none';
            }
        }
    });

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    document.addEventListener('keydown', function(event) {
        const suggestionsContainer = document.getElementById('citySuggestions');
        if (!suggestionsContainer || suggestionsContainer.style.display === 'none') {
            return;
        }

        const items = suggestionsContainer.querySelectorAll('.list-group-item-action');
        let currentIndex = -1;

        items.forEach((item, index) => {
            if (item.classList.contains('active')) {
                currentIndex = index;
            }
        });

        switch(event.key) {
            case 'ArrowDown':
                event.preventDefault();
                if (currentIndex < items.length - 1) {
                    items[currentIndex + 1].click();
                }
                break;

            case 'ArrowUp':
                event.preventDefault();
                if (currentIndex > 0) {
                    items[currentIndex - 1].click();
                }
                break;

            case 'Escape':
                hideCitySuggestions();
                break;

            case 'Enter':
                if (currentIndex >= 0) {
                    event.preventDefault();
                    items[currentIndex].click();
                }
                break;
        }
    });

    console.log('‚úÖ –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –≥–æ—Ä–æ–¥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

// üî• –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞...');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', {
        'notificationSuccess': typeof notificationSuccess,
        'notificationError': typeof notificationError,
        'notificationInfo': typeof notificationInfo,
        'notificationWarning': typeof notificationWarning,
        'toastr': typeof toastr
    });

    // üî• –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –ö–ù–û–ü–ö–£ –ó–ê–ü–£–°–ö–ê/–û–°–¢–ê–ù–û–í–ö–ò
    const toggleBtn = document.getElementById('toggleParserBtn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleParser);
        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
    } else {
        console.error('‚ùå –ö–Ω–æ–ø–∫–∞ toggleParserBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // üî• –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –ö–ù–û–ü–ö–£ –ë–´–°–¢–†–û–ì–û –ó–ê–ü–£–°–ö–ê
    const quickLaunchBtn = document.querySelector('button[onclick="launchParserWithSettings()"]');
    if (quickLaunchBtn) {
        quickLaunchBtn.addEventListener('click', launchParserWithSettings);
        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –≥–æ—Ä–æ–¥–æ–≤
    initializeCityAutocomplete();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–∞–π—Ç–∞
    const siteSelect = document.getElementById('site_select');
    const autoRuTips = document.getElementById('auto_ru_tips');

    if (siteSelect && autoRuTips) {
        // –£–∂–µ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ initializeCityAutocomplete, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É
        if (siteSelect.value === 'auto.ru') {
            autoRuTips.style.display = 'block';

            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ
            const keywordsInput = document.querySelector('textarea[name="keywords"]');
            if (keywordsInput && !keywordsInput.value.trim()) {
                keywordsInput.value = 'ford focus, toyota camry, bmw x5';
                showAlert('–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è Auto.ru', 'info');
            }
        }
    }

    // –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
        if (typeof notificationSuccess === 'function') {
            notificationSuccess('–°–∏—Å—Ç–µ–º–∞ –ø–∞—Ä—Å–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!', '–ü–∞—Ä—Å–µ—Ä');
        }
    }, 1000);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(() => {
        console.log('üîÑ –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...');
        refreshParserStatus();
    }, 1500);

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(refreshParserStatus, 30000);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    setTimeout(addDiagnosticsButton, 2000);

    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
});
</script>
{% endblock %}